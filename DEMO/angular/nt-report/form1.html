<html ng-app="NtCuxiao">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1, maximum-scale=1.0, user-scalable=no"> 
    <meta content="telephone=no" name="format-detection" />  
    <script>
         if (document.documentElement.clientWidth > 1024) { 
           document.querySelector("meta[name=viewport]").setAttribute(
             'content', 
             'width=1024, initial-scale='+(document.documentElement.clientWidth/1024)+', minimum-scale=0.1, maximum-scale=2.0, user-scalable=no');
       }
    </script>
    <link href="assets/css/css.css?r=1849920396" media="screen" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/datatables.css">
    <link rel="stylesheet" href="assets/vendor/sm.min.css">
    <link href="assets/css/style.css"  media="screen" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/sm-nx.css">
    <script src="project.js"></script>
    <script>
       function browserRedirect() {
            var sUserAgent = navigator.userAgent.toLowerCase();
            var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
            var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
            var bIsMidp = sUserAgent.match(/midp/i) == "midp";
            var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
            var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
            var bIsAndroid = sUserAgent.match(/android/i) == "android";
            var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
            var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
            if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
                // document.writeln("phone");
                console.log('ipad');
            } else {
                // document.writeln("pc");
                console.log('pc');
                var link = document.createElement('link');
                link.type = 'text/css';
                link.rel = 'stylesheet';
                link.href = 'assets/css/webSite.css';
                var head = document.getElementsByTagName('head')[0];
                head.append(link);
            }
        }

        browserRedirect();
    </script>
</head>
<!-- 门店库存 -->
<body class="debugx">
<div id="bg"></div>
  <div id="container">
    <header>
      <span class="menu "></span>
      <a class="back_a" href=""><span class="menuBack"></span></a>
      <span tkey="form1"></span><span class="blue" tkey="form1_tittle"></span> 
      <span class="menuRight" tkey="filter"></span>
    </header>

    <!-- 查询后顶部显示的文案，例如
     汇总： 明细 ; 店仓： 博霞路店(本店) ; 范围： 正,负 ; 分类： 大货 ; -->
    <section class="filter hidden ">
      <span tkey="sum"></span>： <span class="filter_reason"></span> ;
      <span tkey="store"></span>： <span class="filter_store"></span> ;
      <span tkey="range"></span>： <span class="filter_range"></span> ;
      <span tkey="category"></span>： <span class="filter_category"></span> ;
    </section>
    
    <!-- 查询条件 -->
    <div class="condition">
      <div class="row" >
        <ul class="col-50" id="condition_ul">
          <!-- 商品编码/条形码 搜索 -->
          <!-- 汇总 -->
          <!-- 门店 -->
          <!-- 范围 -->
          <!-- 分类 -->
        </ul>
        <ul class="col-50" style="width:40%!important">
          <!-- 查询按钮 -->
<li class="col-100">
    <div class="item-content no-border item-button" style="margin-left: 100px">
      	<button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
    </div>
</li>
        </ul>
      </div>
    </div>
    <!-- data 显示 -->
    <!-- data显示 -->
<div class="data hidden">
  <table class="display nx-datatables" id="example" width="100%">
    <thead>
      <tr></tr>
    </thead>
  </table>
  <section class="count" >
    <p class="blue label"><span tkey="heji"></span>|</p>
    <p class="footer"></p>
  </section>
  <!-- loading -->
  <div class="data_content">
    <div>
      <img src="assets/img/loading_b.gif" alt="">
    </div>
  </div>
  <footer id="mainFooter"></footer>
</div>

  </div>

    <script src="assets/vendor/jquery.min.js"></script>

    <script type="text/javascript">
        var jQuery=$.noConflict();
    </script>

    <script src="assets/vendor/fastclick.js"></script> 

    
    <script type="text/javascript" src="assets/vendor/zepto.js"></script>
    <script src="assets/vendor/sm.min.js"></script> 

    <script src="assets/js/common.js"></script>
    <script src="assets/js/api.config.js"></script>
    <!-- <script src="assets/js/host.js"></script> -->
    <script src="assets/vendor/datatables.js"></script>
    <script src="assets/vendor/Scroller-1.4.2/js/dataTables.scroller.min.js"></script>
    <script src="assets/vendor/FixedColumns-3.2.2/js/dataTables.fixedColumns.min.js"></script>
    <script src="assets/vendor/FixedHeader-3.1.2/js/dataTables.fixedHeader.min.js"></script>
    <script src="assets/js/lang.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
<script>
  $(function() {
    FastClick.attach(document.body);
  });
</script> 

<script>
  var xhr_search;
  var selectValue = '';
  var _ID = 0;
  var _count;//获取侧滑id  
  var _NUM = {'product':0,'gift':0};
  var _time_interval = false;
  var shop_id = getUrlParameter('shop_id') * 1;
  // 返回地址
  var lang = getUrlParameter('lang');
  var back_url='index.html'+ '?shop_id=' + shop_id + '&lang=' + lang; 
  $('.back_a').attr('href',back_url);
  var _HEADER = [];//记录header信息

  //  **************  区分是哪个页面，设定缓存  ************** 
  var form_id = 'form1';
</script>

<!-- **************  include相应的条件页面  ************** -->
<!-- 商品编码/条形码 搜索 -->
<!-- 商品编码/条形码 搜索 -->
<div class="condition_div">
  <li>
      <div class="item-content item-search-box">
        	<div class="item-select">
  	        <select>
  	          <option value="product_code" tkey="product_code"></option>
  	          <option value="code" tkey="bar_code"></option>
  	        </select>
        	</div>
        	<div class="item-input">
  	        <input type="text" class="item-input1" placeholder="搜索" placeholder-key="searchs" name="name_code" class="">
        	</div>
      </div>
  </li>
</div>
<script>
  jQuery(document).ready(function($){
    $('.condition_div li').appendTo($('#condition_ul'));

    // 条件从缓存获取
    if(!!localStorage[form_id + '_product_code']){
      $('.item-input1').val(localStorage[form_id + '_product_code']);
      $('.item-search-box .item-select select option[value="product_code"]').attr('selected','selected');
      $('.item-search-box .item-select select option[value="product_code"]').click();
      $('.item-search-box .item-select select option[value="code"]').removeAttr('selected');
    }
    if(!!localStorage[form_id + '_code']){
      $('.item-input1').val(localStorage[form_id + '_code']);
      $('.item-search-box .item-select select option[value="code"]').attr('selected','selected');
      $('.item-search-box .item-select select option[value="code"]').click();
      $('.item-search-box .item-select select option[value="product_code"]').removeAttr('selected');
    }
  })
</script>

<!-- 汇总 -->
<!-- 汇总 -->
<div class="condition_div">
	<li>
	    <div class="item-content item-relative">
	        <label><span tkey="skidding_sum"></span>:</label>
	        <div class="item-input">
	          <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
	          <input type="text" placeholder="请选择需汇总统计项目" placeholder-key="brand_desc" class="btn-panel relative-value" data-rel="panel-reason" readonly="" data-value="storage1" value="">
	        </div>
	    </div>
	</li>
</div>

<!-- panel 汇总 -->
<div class="panel panel-right panel-cover" id='panel-reason'>
  <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="sum"></span>
    <a href="#" class="close-panel confirm confirm_1" tkey="sure"></a>
  </header> 
  <!-- Click on link with "close-panel" class will close panel -->
  <div class="list-block">
  	<p class="small">* <span tkey="desc_sum"></span></p>
  	<ul>
      <!-- Single chekbox item -->
      <li tkey="loading"></li>
  	</ul>
  </div>
</div>
<script>
	jQuery(document).ready(function($){
		$('.condition_div li').appendTo($('#condition_ul'));
	})

	var xhr;
	// init 汇总
	if(xhr){
        xhr.abort();
    }
    xhr = $.ajax({
        url: form_id == 'form8'
             ? (API_URL_PREFIX+API_URL['operation_receipts_group_level'])
                 : (API_URL_PREFIX+API_URL['shop_inventory_view_list']),
        data: JSON.stringify({}),
        type: 'POST',
        dataType : "json",
        contentType: "application/json",
        success:  function(data){
            if(data.code != 0){
                _error_handle(data);
                return;
            }
            data = data.data;
            var str = '';
            var checked_reason = '';
            var view_types = form_id + '_view_types';

            for(i=0;i<data.data.length;i++){
                var name = data.data[i]['type_name'];
                var code = data.data[i]['type_code'];
                if(!!localStorage[view_types]){
                    checked_reason = (localStorage[view_types].split(',').indexOf(code+'') != -1) ? 'checked' : '';
                }

                str += '<li><label class="lb" for="reason'+i+'">\
                  '+ name +'\
                      <span class="checkbox">\
                        <span class="input-radio '+ checked_reason +'">\
                          <input type="radio" name="reason" id="reason'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                          <span class="inner"></span>\
                        </span>\
                      </span></label>\
                    </li>';
            }
            $('#panel-reason ul').html(str);
            $(document).on("click", "#panel-reason .close-panel.confirm_1", function() {
                var s = '';
                if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                    s = '全部汇总类型';
                }else{
                    $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                }
                $('input[data-value="storage1"]').val(s);
                // sessionStorage.setItem('reason1',s);
                $('.filter_reason').html(s);
            });
            // 默认选中
            $('#panel-reason ul li:first-child .input-radio input').click();
            $('#panel-reason input[value="code"]').click();
            
            $('#panel-reason .close-panel.confirm_1').click();
            // 汇总条件从缓存获取
            var filter_reason = form_id + '_filter_reason';
            if(!!localStorage[filter_reason]){
                $('.filter_reason').html(localStorage[filter_reason]);
                $('input[data-value="storage1"]').val(localStorage[filter_reason]);
                $("#panel-reason ul li .input-radio [value='"+localStorage[view_types]+"']").click();
            }else{
                // 默认选中
                $('#panel-reason ul li:first-child .input-radio input').click();
                $('#panel-reason input[value="code"]').click();
            }
        },
        error:    function(data){
            console.log('error'); 
            _error_handle(data);  
        },
        complete: function(){
            console.log('complete');
        },
        beforeSend : function(request){
            request.setRequestHeader("token", token);
        }
    })

</script>

<!-- 店仓 -->
<!-- 店仓 -->
<div class="condition_div">
	<li>
		<div class="item-content item-relative">
		    <label ><span tkey="skidding_store"></span>:</label>
		    <div class="item-input">
		      	<!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
		      	<input type="text" placeholder="请选择需查询店仓(可多选)" placeholder-key="store_desc_input" class="btn-panel relative-value checkAll" data-rel="panel-store" readonly="" data-value="storage2" value="">
		    </div>
	  	</div>
	</li>
</div>
<!-- panel 店仓 -->
<div class="panel panel-right panel-cover" id='panel-store'>
  <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="store"></span> 
    <a href="#" class="close-panel confirm confirm_2" tkey="sure"></a>
  </header>
  <!-- Click on link with "close-panel" class will close panel -->
  <div class="list-block">
    <p class="small">* <span tkey="desc_store"></span></p>
    <p class="all">
      <span tkey="all_check"></span>
      <span class="checkbox">
        <span class="input-checkbox">
          <input type="checkbox" name="type" value="" class="checkedAll" data-label="" />
          <span class="inner"></span>
        </span>
      </span>
    </p>
    <ul>
      <!-- Single chekbox item -->
      <li tkey="loading"></li>
    </ul>
  </div>
</div>
<script>
	jQuery(document).ready(function($){
		$('.condition_div li').appendTo($('#condition_ul'));
	})

	var xhr1;
	//init 店仓
    if(xhr1){
        xhr1.abort();
    }
    var shop_id = getShopId('shop_id=');
    xhr1 = $.ajax({
        url: API_URL_PREFIX+API_URL['shop_list'],
        data: JSON.stringify({"shop_id":shop_id}),
        type: 'POST',
        dataType : "json",
        contentType: "application/json",
        success:  function(data){
            if(data.code != 0){
                _error_handle(data);
                return;
            }
            
            data = data.data;
            var str = '';
            var checked_store = '';
            var shop_ids = form_id + '_shop_ids';

            for(i=0;i<data.shops.length;i++){
                var name = data.shops[i]['shop_name'];
                var code = data.shops[i]['shop_code'];
                var shop_id = data.shops[i]['shop_id'];
                if(!!localStorage[shop_ids]){
                  checked_store = (localStorage[shop_ids].split(',').indexOf(shop_id+'') != -1)?'checked':'';
                }
                str += '<li><label class="lb" for="store'+i+'">\
                        '+ name +'\
                        <span class="checkbox">\
                          <span class="input-checkbox '+ checked_store +'">\
                            <input type="checkbox" name="store" id="store'+i+'" value="'+ shop_id +'" data-label="'+ name +'" />\
                            <span class="inner"></span>\
                          </span>\
                        </span></label>\
                    </li>';
            }
            $('#panel-store ul').html(str);
            $(document).on("click", "#panel-store .close-panel.confirm_2", function() {
                var s = '';
                if($(this).parents('.panel').find('input[type=checkbox]').size() == $(this).parents('.panel').find('input[type=checkbox]:checked').size()){
                    if(langCode == 'en'){
                        s = 'All';
                    }else{
                        s = '全部门店';
                    }
                }else{
                    $(this).parents('.panel').find('input[type=checkbox]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                }
                $('input[data-value="storage2"]').val(s);
                $('.filter_store').html(s);
            });

            // 店仓条件从缓存获取
            var filter_store = form_id + '_filter_store';
            if(!!localStorage[filter_store]){
                $('.filter_store').html(localStorage[filter_store]);
                $('input[data-value="storage2"]').val(localStorage[filter_store]);
                var shop_ids_arr = localStorage[shop_ids].split(',');
                for(var i=0;i<shop_ids_arr.length;i++){
                    $("#panel-store ul li .input-checkbox input[value='"+shop_ids_arr[i]+"']").click();
                }
            }else{
                // 默认选中
                $('#panel-store ul li:first-child .input-checkbox input').click();
            }
            $('#panel-store .close-panel.confirm_2').click();
        },
        error:    function(data){
            console.log('error');
            _error_handle(data);
        },
        complete: function(){
            console.log('complete');
        },
        beforeSend : function(request){
            request.setRequestHeader("token", token);
        }
    })
</script>








<!-- 范围 -->
<!-- 范围 -->
<div class="condition_div">
	<li>
	    <div class="item-content item-relative">
	        <label><span tkey="skidding_range"></span>:</label>
	        <div class="item-input">
	          <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
	          <input type="text" placeholder="请选择存储统计范围" placeholder-key="range_desc" class="btn-panel relative-value" data-rel="panel-range" readonly="" data-value="storage3" value="">
	        </div>
	    </div>
	</li>
</div>
<!-- panel 范围 -->
<div class="panel panel-right panel-cover" id='panel-range'>
  <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="range"></span>
    <a href="#" class="close-panel confirm confirm_3" tkey="sure"></a>
  </header>

  <!-- Click on link with "close-panel" class will close panel -->
  <div class="list-block">
    <p class="small" tkey="range_desc"></p>
    <ul>
      <!-- Single chekbox item -->
      <li>
        <label class="lb" for="range0">
        <span tkey="positive"></span>
        <span class="checkbox">
          <span class="input-checkbox">
            <input type="checkbox" id="range0" name="range" value="positive" data-label="正"/>
            <span class="inner"></span>
          </span>
        </span>
        </label>
      </li>
      <li><label class="lb" for="range1">
        <span>0</span>
        <span class="checkbox">
          <span class="input-checkbox">
            <input type="checkbox" name="range" id="range1" value="zero" data-label="0" />
            <span class="inner"></span>
          </span>
        </span>
        </label>
      </li>
      <li>
        <label class="lb" for="range2">
        <span tkey="negative"></span> 
        <span class="checkbox">
          <span class="input-checkbox">
            <input type="checkbox" name="range" id="range2" value="negative" data-label="负" />
            <span class="inner"></span>
          </span>
        </span>
        </label>
      </li>
      <li>
        <span tkey="customize"></span>
        <span class="checkbox switch">
          <div class="item-input">
            <label class="label-switch">
              <input type="checkbox" value="自定义" data-label="自定义" name="customize">
              <div class="checkbox"></div>
            </label>
          </div>
        </span>
      </li>
      <div class="range">
        <input class="min_count" disabled type="number" name="min_count" /><span>-</span><input class="max_count" disabled type="number" name="max_count" />
      </div>
    </ul>
  </div>
</div>
<script>
	jQuery(document).ready(function($){
		$('.condition_div li').appendTo($('#condition_ul'));

	    // if (langs.indexOf(langCode) != -1){
	    //     $.getJSON('assets/lang/'+langCode+'.json', {},translate1);
	    // }else{
	    //     $.getJSON('assets/lang/cn.json', translate1);
	    // }
	    
		  // 范围条件从缓存获取
      var filter_range = form_id + '_filter_range';
      var count_range = form_id + '_count_range';
      var range_checked = form_id + '_range_checked';
      var max_count = form_id + '_max_count';
      var min_count = form_id + '_min_count';
	    if(!!localStorage[filter_range]){
	        $('.filter_range').html(localStorage[filter_range]);
	        $('input[data-value="storage3"]').val(localStorage[filter_range]);

	        var count_range_arr = localStorage[count_range].split(',');
	        if(localStorage[range_checked] == "false"){
	            for(var i=0;i<count_range_arr.length;i++){
	                // $('#panel-store3 p.all input[type=checkbox]').prop('checked',false);
	                $('#panel-range ul li .input-checkbox input[value='+count_range_arr[i]+']').click();
	                // $('#panel-range ul li .input-checkbox input[value='+form1_count_range[i]+']').prop('checked',true);
	            }
	        }else{
	            $('input[name=customize]')[0].checked = true;
	            $('input[name=customize]').change();
	            $('input[name=max_count]').val(localStorage[max_count]);
	            $('input[name=min_count]').val(localStorage[min_count]);
	            // $('#panel-range .close-panel.confirm_3').click();
	        }
	    }else{
	        $('#panel-range ul li:first-child .input-checkbox input').click();
	        $('#panel-range ul li').eq(2).find('.input-checkbox input').click();
	    }
	    // $('#panel-range .close-panel.confirm_3').click();
	    if(!sessionStorage.getItem('range1')){
	        $('input[data-value="storage3"]').val('正,负');
	        sessionStorage.setItem('range1','正,负');
	        $('.filter_range').html('正,负');
	    }else{
	        $('input[data-value="storage3"]').val(sessionStorage.getItem('range1'));
	        // sessionStorage.setItem('range1',sessionStorage.getItem('range1'));
	        $('.filter_range').html(sessionStorage.getItem('range1'));
	    }
	})
</script>

<!-- 分类 -->
<!-- 分类 -->
<div class="condition_div">
	<li>
	    <div class="item-content item-relative">
	        <label><span tkey="skidding_category"></span>:</label>
	        <div class="item-input">
	          <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
	          <input type="text" placeholder="请选择统计分类(可多选)" placeholder-key="category_desc" class="btn-panel relative-value checkAll" data-rel="panel-category" readonly="" data-value="storage4" value="">
	        </div>
	    </div>
	</li>
</div>
<!-- panel 分类 -->
<div class="panel panel-right panel-cover" id='panel-category'>
  <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="category"></span>
    <a href="#" class="close-panel confirm confirm_4" tkey="sure"></a>
  </header> 
  <!-- Click on link with "close-panel" class will close panel -->
  <div class="list-block">
    <p class="small" tkey="category_desc"></p>
    <p class="all">
      <span tkey="all_check"></span>
      <span class="checkbox">
        <span class="input-checkbox checked">
          <input type="checkbox" name="type" value="" class="checkedAll" data-label="" checked />
          <span class="inner"></span>
        </span>
      </span>
    </p>
    <ul>
      <!-- Single chekbox item -->
      <li tkey="loading"></li>
    </ul>
  </div>
</div>
<script>
	jQuery(document).ready(function($){
		$('.condition_div li').appendTo($('#condition_ul'));
	})
	var xhr2;
	if(xhr2){
        xhr2.abort();
    }
    xhr2 = $.ajax({
        url: form_id == 'form8' ? (API_URL_PREFIX+API_URL['receipt_type']) : (API_URL_PREFIX+API_URL['product_types']),
        data: JSON.stringify({}),
        type: 'POST',
        dataType : "json",
        contentType: "application/json",
        success:  function(data){
            if(data.code != 0){
                _error_handle(data);
                return;
            }
            data = data.data;
            var str_checkbox = '',str_radio = '';
            var checked_category = '';
            var product_type = form_id + '_product_type';

            for(i=0;i<data.data.length;i++){
                var name = data.data[i]['type_name'];
                var code = data.data[i]['type_code'];
                if(!!localStorage[product_type]){
                  checked_category = (localStorage[product_type].split(',').indexOf(code+'') != -1)?'checked':'';
                }
                str_checkbox += '<li><label class="lb" for="category'+i+'">\
                          '+ name +'\
                          <span class="checkbox">\
                            <span class="input-checkbox '+ checked_category +'">\
                              <input type="checkbox" name="category" id="category'+i+'" value="'+ code +'" data-label="'+ name +'"  />\
                              <span class="inner"></span>\
                            </span>\
                          </span></label>\
                        </li>';

                str_radio += '<li><label class="lb" for="category'+i+'">\
                          '+ name +'\
                          <span class="checkbox">\
                            <span class="input-radio '+ checked_category +'">\
                              <input type="radio" name="category" id="category'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                              <span class="inner"></span>\
                            </span>\
                          </span></label>\
                        </li>';
            }
            $('#panel-category ul').html(form_id == 'form8' ? str_radio : str_checkbox);
            $(document).on("click", "#panel-category .close-panel.confirm_4", function() {
                var s = '';
                if($(this).parents('.panel').find('input[type=checkbox]').size() == $(this).parents('.panel').find('input[type=checkbox]:checked').size()){
                    if(langCode == 'en'){
                        s = 'All';
                    }else{
                        s = '全部分类类型';
                    }
                }else{
                    $(this).parents('.panel').find('input[type=checkbox]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                }
                $('input[data-value="storage4"]').val(s);
                // sessionStorage.setItem('category1',s);
                $('.filter_category').html(s);
            });

  			// 分类条件从缓存获取
            var filter_category = form_id + '_filter_category';
            if(!!localStorage[filter_category]){
                $('.filter_category').html(localStorage[filter_category]);
                $('input[data-value="storage4"]').val(localStorage[filter_category]);
                var product_type_arr = localStorage[product_type].split(',');
                for(var i=0;i<product_type_arr.length;i++){
                    $("#panel-category ul li .input-checkbox input[value='"+product_type_arr[i]+"']").click();
                }
            }else{
                // 默认选中
                $('#panel-category ul li:first-child .input-checkbox input').click();
            }
            $('#panel-category .close-panel.confirm_4').click();

            if (langs.indexOf(langCode) != -1){
              $.getJSON('assets/lang/'+langCode+'.json', {},translate);
            }else{
              $.getJSON('assets/lang/cn.json', translate);
            }
        },
        error:    function(data){
            console.log('error');
            _error_handle(data);
        },
        complete: function(){
            console.log('complete');
        },
        beforeSend : function(request){
            request.setRequestHeader("token", token);
        }
    })
</script>

<script>
  // //条件缓存
  // if(sessionStorage.getItem('reason1')){
  //   $('.filter_reason').html(sessionStorage.getItem('reason1'));
  //   $('input[data-value="storage1"]').val(sessionStorage.getItem('reason1'));
  // }
  // if(sessionStorage.getItem('store1')){
  //   $('.filter_store').html(sessionStorage.getItem('store1'));
  //   $('input[data-value="storage2"]').val(sessionStorage.getItem('store1'));
  // }
  // if(sessionStorage.getItem('range1')){
  //   $('.filter_range').html(sessionStorage.getItem('range1'));
  //   $('input[data-value="storage3"]').val(sessionStorage.getItem('range1'));
  // }
  // if(sessionStorage.getItem('category1')){
  //   $('.filter_category').html(sessionStorage.getItem('category1'));
  //   $('input[data-value="storage4"]').val(sessionStorage.getItem('category1'));
  // }

  jQuery(document).ready(function($){
    var table_example;
    var TABLE = '';
    function reset(){
      if(!!table_example){
          table_example.destroy();
      }
      table_example='';
      $('.data table').remove();
      var t = TABLE.clone();
      $('.data').append(t);
    }
    TABLE = $('.data table').clone();
    var render_table_example1 = function(cols){
      var _columns = [];
      //************************
      // 此处修改要排序的col code
      //************************
      var _columns_sort = ['product_code','price','shop_code','stock_count','stock_amount','stock_date'];
      for(var i = 0; i < cols.length; i++){
        if($.inArray(cols[i], _columns_sort) >= 0){
          _columns.push(null);
        }else{
          _columns.push({orderable:false});
        }
      }
      var tbody_height = $(window).height() - $('header')[0].clientHeight - $('section.filter')[0].clientHeight - 50 - $('section.count')[0].clientHeight - $('footer#mainFooter')[0].clientHeight;

      table_example = $('#example').DataTable( {
        scrollX: '100%',
        scrollY: tbody_height,
        searching: false,

        sort:true,
        columns:_columns,
        "bProcessing" : true,  
        "bServerSide" : true, 
        "order": [],
        "ajax":{
          url: API_URL_PREFIX+API_URL['shop_inventory'],
          type:'POST',
          headers: {token:token},
          dataType : "json",
          "contentType": "application/json",
          data: function(d){
            // showLoadingToast();
            // if(cols){
            //   $('#example_processing').hide();
            // }
              
            //************************
            // 此处修改输入参数
            //************************
            var view_type_list = [],shop_ids = [],product_type = [],count_range = [],product_code = '',code = '',min_count,max_count;
            if(selectValue == 'product_code'){
              product_code = sessionStorage.getItem('product_code');
            }else if(selectValue == 'code'){
              code = $('.item-input1').val();
            }else{
              product_code = $('.item-input1').val()
            }
            min_count = $('.min_count').val();
            max_count = $('.max_count').val();
          
            $('input[name=reason]:checked').each(function(){
                view_type_list.push($(this).val());
            })
            $('input[name=store]:checked').each(function(){
                shop_ids.push($(this).val()*1);
            })
            $('input[name=category]:checked').each(function(){
                product_type.push($(this).val());
            })
            $('input[name=range]:checked').each(function(){
                count_range.push($(this).val());
            })

            if(shop_ids.length == 0){
              shop_ids.push(shop_id);
            }
            d.limit = d.length;
            d.offset = d.start;
            d.current_page = 1 + d.start / d.limit;
            d.shop_ids = shop_ids;
            d.product_code = product_code;
            d.code = code;
            d.product_type = product_type;
            d.count_range = count_range;
            d.min_count = min_count;
            d.max_count = max_count;
            d.is_multi = 0;
            // d.view_type_list = view_type_list;
            d.view_types = view_type_list;

            if(d.order.length > 0){
              var _order_by = $('.dataTables_scrollHead th:eq('+d.order[0].column+')').attr('data-code');
              var _is_desc = (d.order[0].dir == 'asc')?0:1;

              d.order_by= _order_by;
              d.is_desc= _is_desc;
            }

            return (JSON.stringify(d));
          },
          dataSrc:  function(data){
            // data = data.data;
            // $('.data_content').hide();
            // hideLoadingToast();
            records = [];
            if(data['records']){
              for(var i = 0 ; i < data['records'].length ; i ++){
                var _data = [];
                for(var j=0; j < cols.length; j++){
                  _data.push(data['records'][i][cols[j]]);
                }
                records.push(_data);
              }
            }
            window.scrollTo(0,0);
            return records
          },
        },
        "initComplete": function(settings, json) {
          $('#mainFooter').html('');
          $('#example_length').appendTo('#mainFooter');
          $('#example_info').appendTo('#mainFooter');
          $('#example_paginate').appendTo('#mainFooter');
          is_show_footer(records);
        },
        "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
        "language":   _LANG
      })
      new $.fn.dataTable.FixedColumns( table_example, {
        leftColumns: 1
      });
    }
    //click search
    $('.nx-btn-display').click(function(){
        $('.data_content').show();
        // showLoadingToast();
        flag = false;
        $('.data').removeClass('hidden');
        if($(this).hasClass('disabled')){
            return;
        }
        $(this).addClass('disabled');
        $(this).html('加载中');
        reset();

        var code = '',product_code = '',min_count,max_count;
        if(selectValue == 'product_code'){
          product_code = $('.item-input1').val();
        }else if(selectValue == 'code'){
          code = $('.item-input1').val();
        }else{
          product_code = $('.item-input1').val()
        }

        min_count = $('.min_count').val();
        max_count = $('.max_count').val();


        var view_type_list = [],shop_ids = [],product_type = [],count_range = [];
        var type = [];

        $('input[name=reason]:checked').each(function(){
            view_type_list.push($(this).val());
        })
        $('input[name=store]:checked').each(function(){
            shop_ids.push($(this).val()*1);
        })
        $('input[name=category]:checked').each(function(){
            product_type.push($(this).val());
        })
        $('input[name=range]:checked').each(function(){
            count_range.push($(this).val());
        })
        if(shop_ids.length == 0){
          shop_ids.push(shop_id);
        }
      

        var data = {
            "limit": 10,
            "current_page": 1, // 当前页码
            "shop_ids": shop_ids, // 店仓
            "product_code": product_code, // 物品编码
            "code": code, // 条码
            product_type:product_type,
            count_range:count_range,
            "min_count": min_count, // 库存范围下限
            "max_count": max_count, // 库存范围上限
            "is_multi": 0, // 是否为复选
            // "view_type_list": view_type_list, // 展示方式
            "view_types": view_type_list, // 展示方式
        }

        //条件放人缓存
        setConditionlocalstorage('form1',data);
        localStorage.form1_range_checked = $('input[name=customize]')[0].checked;
        //门店库存查询
        if(xhr_search){
          xhr_search.abort();
        }  
        xhr_search = $.ajax({
          url: API_URL_PREFIX+API_URL['shop_inventory'],
          data: JSON.stringify(data),
          type: 'POST',
          dataType : "json",
          contentType: "application/json",
          success:  function(data){
            $('.data_content').hide();
            // hideLoadingToast();
            if(data.code != 0){
              _error_handle(data);
              return;
            }
            data = data.data;
            var data_data = {
                'stock_count_sum':'stock_total_qty',
                'page_count':'page_qty',
                'record_count':'record_qty',
                'stock_amount_sum':'stock_total_amount'
            }

            for(var ss in data_data){
                data[ss] = data[data_data[ss]];
            }

            records = [];
            if(data['records']){
              for(var i = 0 ; i < data['records'].length ; i ++){
                records.push([
                  data['records'][i]['product_code'],
                  data['records'][i]['shop_name'],
                  data['records'][i]['product_name'],
                  data['records'][i]['size'],
                  data['records'][i]['price'],
                  data['records'][i]['color'],
                  data['records'][i]['shop_code'],
                  data['records'][i]['stock_count'], 
                  data['records'][i]['stock_amount'],
                  data['records'][i]['stock_date'],
                ])
              }
            }
            // var _data = {
            //     headers:[
            //     {title : data.table_headers.shop_name},
            //     {title : data.table_headers.product_name},
            //     {title : data.table_headers.size},
            //     {title : data.table_headers.price},
            //     {title : data.table_headers.stock_count},
            //     {title : data.table_headers.stock_amount}
            //     ],
            //     records:records
            // };
            var _data = {};
            var cols = [];
            var headers = [];
            var records = [];
            for(var i = 0 ; i < data.table_headers.length ;i++){

                for(var ss in data.table_headers[i]){
                    headers.push({title : data.table_headers[i][ss]});
                    cols.push(ss);
                    if($('table thead tr').length == 1){
                      $('table thead tr').append('<th data-code="'+ss+'">'+data.table_headers[i][ss]+'</th>');
                    }
                    
                }
            }
            for(var i = 0 ; i < data.records.length; i++){
                var tmp = [];
                for(var j=0;j<cols.length;j++){
                    tmp[j] = data.records[i][cols[j]];
                }
                records.push(tmp);
            }
            render_table_example1(cols);
            // _data.records = records;
            // _data.headers = headers;
            // render_table_example1(_data);

            // footer
            var footer = '';
            footer += '<span class="footerStyle"><span tkey="footer1_1"></span>:'+data.stock_count_sum+'</span>\
            <span class="footerStyle"><span tkey="footer1_2"></span>:'+data.stock_amount_sum+'</span>' 
            $('.footer').html(footer);

            // translate();

            if (langs.indexOf(langCode) != -1){
              $.getJSON('assets/lang/'+langCode+'.json', {},translate);
            }else{
              $.getJSON('assets/lang/cn.json', translate);
            }

            },
            error:    function(data){
              console.log('error');
              _error_handle(data);
            },
            complete: function(){
              // hideLoadingToast();
              console.log('complete');
            },
            beforeSend : function(request){
              request.setRequestHeader("token", token);
            }
        })

        console.dir(data);

        $(this).removeClass('disabled');
        $(this).html('查询');
    })
  })
</script>

<script type="text/javascript">
  document.title = '门店库存';
</script>
<script>
var _paq = _paq || [];

_paq.push(['enableLinkTracking', true]);
(function() {
    try {
        var SiteId = getUrlParameter('SiteId');
        var UserId = getUrlParameter('UserId') || '';
        var Appversion = getUrlParameter('Appversion');
        var Platform = getUrlParameter('Platform');
        var ShopName = getUrlParameter('ShopName');
        var TenantName = getUrlParameter('tenant_name');
        var TenantID = getUrlParameter('tenant_id');
        // 如果SiteId是false,则不发送Piwik数据
        if(SiteId == '' || SiteId == false){
            return
        }
        var u="//a.nexttao.com/";
        // 当url为空不发送
        if(u == "" || u == "false" || u == false){
            return
        }

        if(!!UserId){
            _paq.push(['setUserId', UserId]);
        }
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', SiteId]);
        _paq.push(['setDocumentTitle', '促销规则查询']);

        _paq.push(['setCustomVariable',"5","AppVersion",P_CV.AppVersion,'page']);

        // _paq.push(['setCustomVariable',"1","App version",Appversion]);
        // _paq.push(['setCustomVariable',"2","Platform",Platform]);
        // _paq.push(['setCustomVariable',"3","ShopName",ShopName]);
        // _paq.push(['setCustomVariable',"4","TenantID",TenantName]);
        // _paq.push(['setCustomVariable',"5", "TenantName", TenantName]);
        _paq.push(['trackPageView']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    }catch (e){
        console.log(e);
    }
})();
</script>

</body>
</html>
