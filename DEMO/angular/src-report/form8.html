<#include 'inc.head.html'>
<!-- * 业务单据 -->
<body class="debugx">
<div id="bg"></div>
  <div id="container">
    <header>
        <span class="menu"></span>
        <a class="back_a" href="index.html"><span class="menuBack"></span></a>
        <span tkey="form8_danju"></span><span class="blue" tkey="danju"></span>
        <span class="menuRight" tkey="filter"></span>
    </header>

    <section class="filter hidden">
      <span tkey="sum"></span>： <span class="filter_reason"></span> ；
      <span tkey="category"></span>： <span class="filter_category"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
    </section>

    <div class="condition">
      <div class="row" >
        <ul class="col-50" id="condition_ul">
          <!-- 商品编码 -->
          <!-- 汇总 -->
          <!-- 分类 -->
          <!-- 日期 -->
        </ul>
        <ul class="col-50" style="width:40%!important">
          <#include 'btn_search.html'>
        </ul>
      </div>
    </div>
    <!-- data 显示 -->
    <#include 'data_content.html'>
  </div>
<#include 'inc.script.html'>

<script>
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var back_url='index.html'+ '?shop_id=' + shop_id + '&lang=' + lang; 
$('.back_a').attr('href',back_url);

//  **************  区分是哪个页面，设定缓存  ************** 
var form_id = 'form8';
//  **************  是否显示合计  ************** 
// $('.count').hide();
</script>

<!-- 商品编码 -->
<#include 'condition_product.html'>
<!-- 汇总 -->
<#include 'condition_sum.html'>
<!-- 分类 -->
<#include 'condition_category.html'>
<!-- 日期 -->
<#include 'condition_start_end_date.html'>

<script>

  jQuery(document).ready(function($){

    $('.nx-btn-product-search').click(function(){
      var val = $.trim($('#productCode').val());
      var r = /^\d+$/;

      if(r.test(val) == true)  
       {  
          if(val.length < 6){
            showError('SKU至少输入6位');
            $('#productCode').focus();
            return false;
          }else{
            clearError();
          }
       }  
      else  
      {  
        if(val.length < 2){
          showError('商品名称至少输入2个字符');
          $('#productCode').focus();
          return false;
        }else{
          clearError();
        }
      }  
      tab2_click_callback();
    })

    var table_example;
    var TABLE = '';
    function reset(){
      if(!!table_example){
          table_example.destroy();
      }
      table_example='';
      $('.data table').remove();
      var t = TABLE.clone();
      $('.data').append(t);
    }
    TABLE = $('.data table').clone();

    var render_table_example1 = function(cols){
      // if(!!table_example){
      //   table_example.ajax.reload();
      //   return;
      // }
      var _columns = [];
      var _columns_sort = ['target_shop'];
      for(var i = 0; i < cols.length; i++){
        if($.inArray(cols[i], _columns_sort) >= 0){
          _columns.push({orderable:false});
        }else{
          _columns.push(null);
        }
      }

      var tbody_height = $(window).height() - $('header')[0].clientHeight - $('section.filter')[0].clientHeight - 50 - $('section.count')[0].clientHeight - $('footer#mainFooter')[0].clientHeight;

      table_example = $('#example').DataTable({
        scrollX: '100%',
        scrollY: tbody_height,
        searching: false,
        sort:true,
        columns:_columns,
        order:[],
        "bProcessing" : true,  
        "bServerSide" : true,

        ajax:{
          url: API_URL_PREFIX+API_URL['operation_receipts'],
          type: 'POST',
          headers:{token:token},
          dataType : "json",
          contentType: "application/json",
          data:function(d){
            // showLoadingToast();
            d.limit = d.length;
            d.offset = d.start;
            d.current_page = 1 + d.start / d.limit;
            d.shop_id = shop_id;
            d.start_date = $('input[name=start_at]').val();
            d.end_date = $('input[name=end_at]').val();
            d.product_code = $('input[name=name_code]').val();
            d.receipt_type = $('input[name=category]:checked').val();
            // d.group_level = $('input[name=reason]:checked').val();
            d.group_by = $('input[name=reason]:checked').val();
            
            if(d.order.length > 0){
              var _order_by = $('.dataTables_scrollHead th:eq('+d.order[0].column+')').attr('data-code');
              var _is_desc = (d.order[0].dir == 'asc')?0:1;

              d.order_by= _order_by;
              d.is_desc= _is_desc;
            }
            return (JSON.stringify(d));
          },
          dataSrc:  function(data){
            // data = data.data;
            // $('.data_content').hide();
            // hideLoadingToast();
            records = [];
            if(data['records']){
              for(var i = 0 ; i < data['records'].length ; i ++){
                var _data = [];
                  for(var j=0; j < cols.length; j++){
                    _data.push(data['records'][i][cols[j]]);
                  }
                  records.push(_data);
              }
            }
            window.scrollTo(0,0);
            return records
          },
        },
          
        "initComplete": function(settings, json) {
          $('#mainFooter').html('');
          $('#example_length').appendTo('#mainFooter');
          $('#example_info').appendTo('#mainFooter');
          $('#example_paginate').appendTo('#mainFooter');
          is_show_footer(records);
        },
        "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
        "language":   _LANG
      });
    }

    //click search
    $('.nx-btn-display').click(function(){
      $('.data_content').show();
      // showLoadingToast();
      flag = false;
      $('.data').removeClass('hidden');
      $('.allDate').html($('input[name=start_at]').val() +'至'+ $('input[name=end_at]').val() );
      if($(this).hasClass('disabled')){
          return;
      }
      $(this).addClass('disabled');
      $(this).html('加载中');
      reset();
      var data = {
        "limit": 10, //# 每页数量
        "current_page": 1, //# 当前页码
        "start_date": $('input[name=start_at]').val(), //# 开始日期
        "end_date": $('input[name=end_at]').val(), //# 结束日期
        "product_code": $('input[name=name_code]').val(),
        "receipt_type": $('input[name=category]:checked').val(), //# 单据类型
        // "group_level": $('input[name=reason]:checked').val(), //# 汇总级别
        "group_by": $('input[name=reason]:checked').val(), //# 汇总级别
        "shop_id": shop_id
      }

      //条件放人缓存
      setConditionlocalstorage('form8',data);

      //业务单据查询
      if(xhr){
        xhr.abort();
      }  
      xhr = $.ajax({
        url: API_URL_PREFIX+API_URL['operation_receipts'],
        data: JSON.stringify(data),
        type: 'POST',
        dataType : "json",
        contentType: "application/json",
        success:  function(data){
          $('.data_content').hide();
          if(data.code != 0){
            _error_handle(data);
            return;
          }
          data = data.data;
          var data_data = {
              'page_count':'page_qty',
              'record_count':'record_qty'
          }
          for(var ss in data_data){
              data[ss] = data[data_data[ss]];
          }
          records = [];
          if(data['records']){
            for(var i = 0 ; i < data['records'].length ; i ++){
              records.push([
                data['records'][i]['sale_code'],
                data['records'][i]['brand'],
                data['records'][i]['sale_count'],
                data['records'][i]['sale_amount'],
                data['records'][i]['stock_count'], 
                data['records'][i]['stock_amount']
              ])
            }
          }
          var _data = {};
          var cols = [];
          var headers = [];
          var records = [];
          for(var i = 0 ; i < data.table_headers.length ;i++){
            for(var ss in data.table_headers[i]){
              headers.push({title : data.table_headers[i][ss]});
              cols.push(ss);
              if($('table thead tr').length == 1){
                $('table thead tr').append('<th data-code="'+ss+'">'+data.table_headers[i][ss]+'</th>');
              }
            }
          }
          for(var i = 0 ; i < data.records.length; i++){
            var tmp = [];
            for(var j=0;j<cols.length;j++){
                tmp[j] = data.records[i][cols[j]];
            }
            records.push(tmp);
          }
          // _data.records = records;
          // _data.headers = headers;
          render_table_example1(cols);

          // footer
          var footer = '';
          for(var i = 0;i< data.footer.length;i++){
            footer += '<span class="footerStyle">'+data.footer[i].type_name+':'+data.footer[i].type_mount+'</span>\
            ' 
            $('.footer').html(footer);
          }
          if (langs.indexOf(langCode) != -1){
            $.getJSON('assets/lang/'+langCode+'.json', {},translate);
          }else{
            $.getJSON('assets/lang/cn.json', translate);
          }
        },
        error:    function(data){
          console.log('error');
          _error_handle(data);
        },
        complete: function(){
          console.log('complete');
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
        }
      })
      $(this).removeClass('disabled');
      $(this).html('查询');
    })
  })
</script>

<script type="text/javascript">
  document.title = '业务单据';
</script>
<#include 'inc.bottom.html'>