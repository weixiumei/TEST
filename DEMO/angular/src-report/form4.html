<#include 'inc.head.html'>
<!-- 销售环比 -->
<body class="debugx">
<div id="bg"></div>
  <div id="container">
    <header>
        <span class="menu"></span>
        <a class="back_a" href=""><span class="menuBack"></span></a>
        <span tkey="form2"></span><span class="blue" tkey="form4_tittle"></span>
        <span class="menuRight" tkey="filter"></span>
    </header>

    <section class="filter hidden">
      <span tkey="circle"></span>： <span class="filter_circle"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
    </section>
    <div class="condition">
      <div class="row" >
        <ul class="col-50" id="condition_ul">
          <!-- 环比 -->
          <!-- 日期 -->
        </ul>
        <ul class="col-50" style="width:40%!important">
          <#include 'btn_search.html'>
        </ul>
      </div>
    </div>
    <!-- data 显示 -->
    <#include 'data_content.html'>
  </div>
<#include 'inc.script.html'>

<script>
var xhr;
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var back_url='index.html'+ '?shop_id=' + shop_id + '&lang=' + lang; 
$('.back_a').attr('href',back_url);

//  **************  区分是哪个页面，设定缓存  ************** 
var form_id = 'form4';
//  **************  是否显示合计  ************** 
$('.count').hide();
</script>

<!-- 环比 -->
<#include 'condition_circle.html'>

<!-- 日期 -->
<#include 'condition_start_end_date.html'>

<script>
jQuery(document).ready(function($){

  $('.nx-btn-product-search').click(function(){
    var val = $.trim($('#productCode').val());
    var r = /^\d+$/;
    if(r.test(val) == true)  
     {  
        if(val.length < 6){
          showError('SKU至少输入6位');
          $('#productCode').focus();
          return false;
        }else{
          clearError();
        }
     }  
    else  
    {  
      if(val.length < 2){
        showError('商品名称至少输入2个字符');
        $('#productCode').focus();
        return false;
      }else{
        clearError();
      }
    }  
    tab2_click_callback();
  })

  var table_example;
  var TABLE = '';
  function reset(){
    if(!!table_example){
        table_example.destroy();
    }
    table_example='';
    $('.data table').remove();
    var t = TABLE.clone();
    $('.data').append(t);
  }

  TABLE = $('.data table').clone();
  var render_table_example1 = function(data){
    $('.data').removeClass('hidden');
      // if(typeof table_example !== 'undefined'){
      //     table_example.destroy();
      // }
      var tbody_height = $(window).height() - $('header')[0].clientHeight - $('section.filter')[0].clientHeight - 50 - $('footer#mainFooter')[0].clientHeight;
      table_example = $('#example').DataTable( {
        data: data.records,
        columns: data.headers,
        scrollX: '100%',
        scrollY: tbody_height,
        searching: false,
        sort:false,
        "initComplete": function(settings, json) {
          $('#mainFooter').html('');
          $('#example_length').appendTo('#mainFooter');
          $('#example_info').appendTo('#mainFooter');
          $('#example_paginate').appendTo('#mainFooter');
          window.scrollTo(0,0);
        },
    "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
    "language":   _LANG
    });
  }

  //click search
  $('.nx-btn-display').click(function(){
    $('.data_content').show();
    // $('.data_content')[0].style.display = "block"
    // showLoadingToast();
    flag = false;
    $('.allDate').html($('input[name=start_at]').val() +'至'+ $('input[name=end_at]').val() );
    if($(this).hasClass('disabled')){
        return;
    }
    $(this).addClass('disabled');
    $(this).html('加载中');
    reset();

    var reason_ids = [];
    var type = [];

    $('input[name=reason]:checked').each(function(){
        reason_ids.push($(this).val() * 1);
    })
    $('input[name=type]:checked').each(function(){
        type.push($(this).val());
    })
    var shop_id = getShopId('shop_id=');
    var data = {
      "start_date":$('input[name=start_at]').val(),
      "end_date":$('input[name=end_at]').val(),
      shop_id:shop_id,
      section:$('input[name=circle]:checked').val()
    }

    //条件放人缓存
    setConditionlocalstorage('form4',data);

    //销售环比查询
    if(xhr){
      xhr.abort();
    }  
    xhr = $.ajax({
      url: API_URL_PREFIX+API_URL['sale_chain_rate'],
      data: JSON.stringify(data),
      type: 'POST',
      dataType : "json",
      contentType: "application/json",
      success:  function(data){
        $('.data_content').hide();
        if(data.code != 0){
          _error_handle(data);
          return;
        }
        data = data.data;
        // hideLoadingToast();
        records = [];
        if(data['records']){
          for(var i = 0 ; i < data['records'].length ; i ++){
            records.push([
              data['records'][i]['sale_code'],
              data['records'][i]['brand'],
              data['records'][i]['sale_count'],
              data['records'][i]['sale_amount'],
              data['records'][i]['stock_count'], 
              data['records'][i]['stock_amount']
            ])
          }
        }
        var _data = {};
        var cols = [];
        var headers = [];
        var records = [];
        for(var i = 0 ; i < data.table_headers.length ;i++){
          for(var ss in data.table_headers[i]){
            headers.push({title : data.table_headers[i][ss]});
            cols.push(ss);
          }
        }
        for(var i = 0 ; i < data.records.length; i++){
          var tmp = [];
          for(var j=0;j<cols.length;j++){
              tmp[j] = data.records[i][cols[j]];
          }
          records.push(tmp);
        }
        _data.records = records;
        _data.headers = headers;
        render_table_example1(_data);
      },
      error:    function(data){
        console.log('error');
        _error_handle(data);
      },
      complete: function(){
        // hideLoadingToast();
        $('.data_content').hide();
        console.log('complete');
      },
      beforeSend : function(request){
        request.setRequestHeader("token", token);
      }
    })
    $(this).removeClass('disabled');
    $(this).html('查询');
  })
  $('.hasext').click(function(){
    $(this).toggleClass('ext');
    if($(this).hasClass('ext')){
        $(this).next('.wrap').slideDown();
    }else{
        $(this).next('.wrap').slideUp();
    }
  })
  var tbl = {
      tblProduct:'',
      tblGift:'',
  };

  var render_table_example = function(id,data){
    if((typeof tbl !== 'undefined') && (typeof tbl[id] !== 'undefined') && (tbl[id] != '')){
        tbl[id].destroy();
    }
    tbl[id] = $('#'+id).DataTable( {
      data: data.records,
      columns: data.headers,
      scrollX: '100%',
      scrollY: '360',//768 - 70 - 50 - 50 - 50 - 66 
      //searching: false,
      sort:false,
      // fixedHeader: {
      //     header: true,
      //     footer: true
      // },
      "initComplete": function(settings, json) {
        // showLoadingToast();
        $('#detailContent footer').html('');
        $('#detailContent footer').removeClass('hidden');
        $('#'+id + '_length').appendTo('#detailContent footer');
        $('#'+id + '_info').appendTo('#detailContent footer');
        $('#'+id + '_paginate').appendTo('#detailContent footer');
        $('tr.odd').removeClass('odd');
        $('tr.even').removeClass('even');

        if(id == 'tblProduct'){
          $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
        }
        if(id == 'tblGift'){
          $('.cx-gift footer').removeClass('hidden');
        }
      },
      "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
      "language":   _LANG
    })
    $('.button[data-table="#'+id+'"]').unbind('click').bind('click',function(){
      $('#'+id).DataTable()
      .search( $(this).parents('.condition').find('input').val() )
      .draw();
    })
  }
})
</script>

<script type="text/javascript">
  document.title = '销售环比';
</script>
<#include 'inc.bottom.html'>