<#include 'inc.head.html'>

<body class="debugx">
<div id="bg"></div>
  <div id="container">
    <header>
        <span class="menu"></span>
        <a class="back_a" href=""><span class="menuBack"></span></a>
        <span tkey="other_form10"></span><span class="blue">促销查询</span>
        <span class="menuRight" tkey="filter"></span>
    </header>

    <section class="filter hidden">
      <span>活动类型</span>： <span class="filter_reason"></span> ；
      <span>状态</span>： <span class="filter_type"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
    </section>
    <section class="filter2 hidden">
      <img src="assets/img/close.png">
      <b><span tkey="form13_tittle"></span></b>
      <span tkey="filter_condition"></span>：<span class="product_code"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
    </section>

<div class="condition">

    <div class="row" >
    <ul class="col-50">
      <li>
        <div class="item-content item-search">
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="搜索..." name="name_code" class="">
            </div>
          </div>
      </li>
      <li>
        <div class="item-content item-relative">
            <label><span>活动类型</span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请选择活动类型" class="btn-panel relative-value" data-rel="panel-reason" readonly="" data-value="storage" value="全部活动类型">
            </div>
          </div>
      </li>
      
      <li>
        <div class="item-content item-relative">
          <label><span>状态</span>:</label>
          <div class="item-input">
            <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
            <input type="text" placeholder="请选择状态" class="btn-panel" data-rel="panel-type" readonly="" data-value="type" value="全部状态">
          </div>
        </div>
      </li>
      
      <li>
        <div>
          <input type="date" data-toggle="date" class="datepicker" value="" name="start_at">
          <span class="datepicker-split">-</span>
          <input type="date" data-toggle="date" class="datepicker" value="" name="end_at">
        </div>
      </li>
      </ul>
      <ul class="col-50" style="width:40%!important">
        <li class="col-100">
          <div class="item-content no-border item-button" style="margin-left: 100px">
            <!-- <button class="button button-fill button-primary" id="clear" tkey="clear">重置</button> -->
            <button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <div class="data hidden">
      <table class="display nx-datatables" id="example" width="100%">
      </table>
      <footer id="mainFooter">
        
      </footer>
    </div>
</div>
<!-- 促销详情 -->
<div id="detailContent" class="">
  <header>
    <span class="back"></span>
      促销规则详情
  </header>
  <div class="buttons-tab fixed-tab" data-offset="44">
    <a href="#tab1" class="tab-link active button">促销详情</a>
    <a href="#tab2" class="tab-link button">促销商品</a>
    <a href="#tab3" class="tab-link button">促销赠品</a>
  </div>
  <div class="tabs">
    <div id="tab1" class="tab active">
      <div class="loading loading-detail"> 加载中 ...</div>
      <div class="content-block cx-detail hidden">
        <div class="timeline clearfix">
          <div class="line"></div>
          <p data-rel='start_time'></p>
          <p class="counter" data-rel='counter_str'></p>
          <p data-rel='end_time'></p>
        </div>
        <div class="clearfix"></div>
        <h1 data-rel='promotion_name'></h1>
        <h2 data-rel='promotion_code'></h2>
        <article>
          <p >
            促销说明：<span data-rel='promotion_notes'></span>
          </p>
          <p>
            活动类型：<span data-rel='promotion_type_name'></span>
          </p>
          <p class="description">
            计算与叠加: <span data-rel="compute_notes"></span> 
          </p>
          <p class="description">
            参与会员: <span data-rel="member_levels"></span> 
          </p>

          <table class="cx">
            <thead>
              <tr>
                <th class="label">会员等级</th>
                <th class="label">会员折扣</th>
              </tr> 
            </thead>
            <tbody>
              <tr>
                <td data-rel='member_level_name'></td>
                <td data-rel='member_discount'></td>
              </tr>  
            </tbody>
            <tfoot></tfoot>
          </table>
        </article>
      </div>
    </div>
    <div id="tab2" class="tab">
      <div class="loading loading-product"> 加载中 ...</div>
      <div class="content-block cx-product tab2 hidden">
          <!-- <select name="" id="select">
            <option value="include_scope">促销包含</option>
            <option value="exclude_scope">促销排除</option> 
          </select> -->
          <div class="select">
            <div class="radio">
            <label for="include">
              <input type="radio" name="tab2_tab" data-type="include_scope" checked="checked" id="include">  包含
            </label>  
            <label for="exclude">
              <input type="radio" name="tab2_tab" data-type="exclude_scope" id="exclude">   排除
            </label>
            </div>
          </div>
        <div class="cx-title hasext ext">
          属性定义
        </div>
        <div class="wrap has include_scope">
          <table class="cx">
            <thead></thead>
            <tbody>
              <tr>
                <td>名称</td>
                <td>数量条件</td>
                <td>金额条件</td>
                <td>促销折扣</td>
                <td>优惠金额</td>
                <td>一口价</td>
              </tr>
            </tbody>
            <tfoot></tfoot>
          </table>
        </div>
        <div class="wrap nohas exclude_scope">
          <table class="cx">
            <thead></thead>
            <tbody>
              <tr>
                <td>名称</td>
                <td>数量条件</td>
                <td>金额条件</td>
                <td>促销折扣</td>
                <td>优惠金额</td>
                <td>一口价</td>
              </tr>
            </tbody>
            <tfoot></tfoot>
          </table>
        </div>
        <div class="wrap">
          <div class="condition">
            <span class="error"></span>
            <div style="    display: -webkit-inline-box;position: relative;left: -6%;"><span>商品明细</span>
              <div class="radio" style="display: inline-block;position: relative;right: -41px;">
                <label for="tab_in">
                  <input type="radio" name="tab2" data-type="true" checked="checked" id="tab_in" value="true">  包含
                </label>
                <label for="tab_ex">
                  <input type="radio" name="tab2" data-type="false" id="tab_ex" value="false">   排除
                </label>
              </div>
            </div>
            <div class="item-content item-search">
                <div class="item-input">
                  <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
                  <input type="text" placeholder="请输入SKU／物品名称查找" id="productCode"  value="">
                </div>
            </div>
            <button class="button button-fill button-primary nx-btn-product-search">查询</button>
          </div>
          <table class="display nx-datatables" id="tblProduct" width="100%">
          </table>

                <footer>
                  
                </footer>
        </div>
      </div>
    </div>
    <div id="tab3" class="tab">
      <div class="loading loading-gift"> 加载中 ...</div>
      <div class="content-block cx-product cx-gift hidden">
        <div class="cx-title hasext ext">属性定义</div>
        <div class="wrap has include_scope">
          <table class="cx">
            <thead></thead>
            <tbody>
              <tr>
                <td>名称</td>
                <td>数量条件</td>
                <td>金额条件</td>
                <td>促销折扣</td>
              </tr>
            </tbody>
            <tfoot></tfoot>
          </table>
        </div>

        <div class="wrap">
          <div class="condition">
            <span class="error"></span>
            <div style="    display: -webkit-inline-box;position: relative;left: -6%;">
            <span>商品明细</span>
              <div class="radio" style="display: inline-block;position: relative;right: -41px;">
                <label for="tab3_in">
                  <input type="radio" name="tab3" data-type="true" checked="checked">  包含
                </label>
                <label for="tab3_ex">
                  <input type="radio" name="tab3" data-type="false" id="tab3_ex">   排除
                </label>
              </div>
            </div>
            <div class="item-content item-search">
                <!-- <div class="resultRecord">商品明细</div> -->
                <div class="item-input">
                  <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
                  <input type="text" placeholder="请输入SKU／物品名称查找" id="giftCode"  value="">
                </div>
            </div>
            <button class="button button-fill button-primary nx-btn-gift-search">查询</button>
          </div>
            <table class="display nx-datatables" id="tblGift" width="100%">
                </table>

                <footer>
                  
                </footer>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- * 活动类型-->
<div class="panel panel-right panel-cover" id='panel-reason'>
    <header>
      <a href="#" class="close-panel back"></a>  
      活动类型
      <a href="#" class="close-panel confirm">确定</a>
    </header>
    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small">* 请选择活动类型</p>
        <label class="lb" for="all">
          <p class="all">
            全选
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="all" value="" data-label=""/>
                <span class="inner"></span>
              </span>
            </span>
          </p>
        </label>
      <ul>
        <!-- Single chekbox item -->
        <li>
          <label class="lb" for="label1">
          折扣  
            <span class="checkbox">
              <span class="input-checkbox checked">
                <input type="checkbox" name="reason" id="label1" value="discount" data-label="折扣" checked/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="label2">
            满减
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="label2" value="reduce" data-label="满减"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="label3">
            一口价
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="label3" value="fixed" data-label="一口价"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="label4">
            赠品
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="label4" value="gift" data-label="赠品"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="label5">
            调价
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="label5" value="tuned" data-label="调价"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="label6">
            会员
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="reason" id="label6" value="vip" data-label="会员"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
      </ul>
      </div>
</div>
<!-- 状态 -->
<div class="panel panel-right panel-cover" id='panel-type'>
    <header>
      <a href="#" class="close-panel back"></a>  
      状态
      <a href="#" class="close-panel confirm">确定</a>
    </header>

    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small">* 请选择促销对象</p>
        <label class="lb" for="alls">
          <p class="all">
            全选
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="type" id="alls" value="" data-label=""/>
                <span class="inner"></span>
              </span>
            </span>
          </p>
        </label> 
      <ul>
        <!-- Single chekbox item -->
        <li>
          <label class="lb" for="labels1">
            进行中
            <span class="checkbox">
              <span class="input-checkbox checked">
                <input type="checkbox" name="type" id="labels1" value="in_progress" data-label="进行中" checked />
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="labels2">
            未开始
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="type" id="labels2"  value="not_start" data-label="未开始"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
        <li>
          <label class="lb" for="labels3">
            已结束
            <span class="checkbox">
              <span class="input-checkbox">
                <input type="checkbox" name="type" id="labels3"  value="ended" data-label="已结束"/>
                <span class="inner"></span>
              </span>
            </span>
          </label>
        </li>
      </ul>
      </div>
</div>
 
<#include 'inc.script.html'>
<script>
var xhr,xhr1;
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var back_url='index.html'+ '?shop_id=' + shop_id + '&lang=' + lang; 
$('.back_a').attr('href',back_url);


//点击弹出右侧的panel    
$(document).on("click", ".btn-panel", function() {
    var id = $(this).attr('data-rel');
    $.openPanel("#"+id);
    $('#bg').show();
    _count = "#"+id;
    $('.panel.panel-right.panel-cover'+_count+' ').show();
});
$('.panel header .back').on("click",function(){
  $('#bg').hide();
})
$('#bg').on("click",function(){
  $.closePanel(_count);
  $(this).hide();
})
$('.panel header .confirm').on("click",function(){
  $('#bg').hide();
})
// 点击背景可以直接回填值
$(document).on("close", ".panel", function(e, pageId, $page) {
  $(this).find('.close-panel').click();
  $(this).find('.close-panel').click();
});


$('#panel-reason').on("change", "p.all input", function() {
    var t = $(this).prop('checked');
    if(t){
      $('#panel-reason ul .input-checkbox').addClass('checked');
    }else{
      $('#panel-reason ul .input-checkbox').removeClass('checked');
    }
    $('#panel-reason ul input[type=checkbox]').prop('checked',t);
})
$('#panel-reason').on("change", "ul input", function() {
    if($(this).parents('.panel').find('ul input[type=checkbox]:not(:checked)').size() == 0){
      $('#panel-reason p.all .input-checkbox').addClass('checked');
      $('#panel-reason p.all input[type=checkbox]').prop('checked',true);
    }else{
      $('#panel-reason p.all .input-checkbox').removeClass('checked');
      $('#panel-reason p.all input[type=checkbox]').prop('checked',false);
    }
})
$(document).on("click", "#panel-reason .close-panel.confirm", function() {
    var s = '';
    if($(this).parents('.panel').find('ul input[type=checkbox]:not(:checked)').size()  == 0){
      s = '全部活动类型';
    }else{

      $(this).parents('.panel').find('input[type=checkbox]:checked').each(function(){
          if(s != ''){
              s += ',';
          }
          s +=  $(this).attr('data-label');
      });
    }
    $('input[data-value="storage"]').val(s);

    $('.filter_reason').html(s);
});

$('#panel-type').on("change", "p.all input", function() {
    var t = $(this).prop('checked');
    if(t){
      $('#panel-type ul .input-checkbox').addClass('checked');
    }else{
      $('#panel-type ul .input-checkbox').removeClass('checked');
    }
    $('#panel-type ul input[type=checkbox]').prop('checked',t);
})
$('#panel-type').on("change", "ul input", function() {
    if($(this).parents('.panel').find('ul input[type=checkbox]:not(:checked)').size() == 0){
      $('#panel-type p.all .input-checkbox').addClass('checked');
      $('#panel-type p.all input[type=checkbox]').prop('checked',true);
    }else{
      $('#panel-type p.all .input-checkbox').removeClass('checked');
      $('#panel-type p.all input[type=checkbox]').prop('checked',false);
    }
})

$(document).on("click", "#panel-type .close-panel.confirm", function() {
    var s = '';
    if($(this).parents('.panel').find('ul input[type=checkbox]:not(:checked)').size() == 0){
      s = '全部对象';
    }else{

      $(this).parents('.panel').find('input[type=checkbox]:checked').each(function(){
          if(s != ''){
              s += ',';
          }
          s +=  $(this).attr('data-label');
      });
    }
    $('input[data-value="type"]').val(s);

    $('.filter_type').html(s);

});
// $('#select').change(function(){
//   sessionStorage.setItem('select',$(this).val());
//   if($(this).val() == 'include_scope'){
//     $('#tab2 .wrap.nohas').hide();
//     $('#tab2 .wrap.has').show();
//   }else{
//     $('#tab2 .wrap.nohas').show();
//     $('#tab2 .wrap.has').hide();
//   }
// })
$('input[name=tab2_tab]').change(function(){
  if($('input[name=tab2_tab]:checked').attr('data-type') == 'include_scope'){
    $('#tab2 .wrap.nohas').hide();
    $('#tab2 .wrap.has').show();
  }else{
    $('#tab2 .wrap.nohas').show();
    $('#tab2 .wrap.has').hide();
  }
})

jQuery(document).ready(function($){

  // 筛选
  var flag = true; 
  $('.menuRight').click(function(){
    if(flag){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
      $('.data').removeClass('hidden');
      flag = false;
    }else{
      $('.filter').addClass('hidden');
      $('#container > .condition').removeClass('hidden');
      $('.data').addClass('hidden');
      flag = true;
    }
  })

  var date = new Date();
  var didDate = date.setDate(date.getDate()-6);
  var year = date.getFullYear();
  var month = date.getMonth()+1;
  var day = date.getDate();
  if(String(month).length == 1){
    month = '0' + month;
  }
  if(String(day).length == 1){
    day = '0' + day;
  }
  var year_month_day = year + '-' + month + '-' + day +'';

  if(sessionStorage.getItem('start2')){
    $('.startDate').text(sessionStorage.getItem('start2'));
    $('input[name=start_at]').val(sessionStorage.getItem('start2'))
  }else{
    $('input[name=start_at]').val(year_month_day);
    $('.startDate').text($('input[name=start_at]').val());
  }
  if(sessionStorage.getItem('end2')){
    $('.endDate').text(sessionStorage.getItem('end2'));
    $('input[name=end_at]').val(sessionStorage.getItem('end2'))
  }else{
    $('input[name=end_at]').val(new Date().Format("yyyy-MM-dd"));
    $('.endDate').text($('input[name=end_at]').val());
  }

  $('input[name=start_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=start_at]').val($('input[name=end_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('start2',$('input[name=start_at]').val());
  })
  $('input[name=end_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=end_at]').val($('input[name=start_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('end2',$('input[name=end_at]').val());
  })

  $('.filterButton').click(function(){
    $('.filter').addClass('hidden');
    $('#container > .condition').removeClass('hidden');
  })
  $('#getList').click(function(){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
  })

  $('.radio input[name=tab2]').change(function(){
    $('#tab2 .cx-product .wrap.has.include_scope tbody tr:not(:first-child)').empty()
    $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody tr:not(:first-child)').empty()
    if($(this).attr('data-type') == 'false'){
      tab2_click_callback();
    }else if($(this).attr('data-type') == 'true'){
      tab2_click_callback();
    }
  })
  $('.radio input[name=tab3]').change(function(){
    if($(this).attr('data-type') == 'false'){
      tab3_click_callback();
    }else if($(this).attr('data-type') == 'true'){
      tab3_click_callback();
    }
  })
  $('.nx-btn-product-search').click(function(){
    $('#tab2 .cx-product .wrap.has.include_scope tbody tr:not(:first-child)').empty()
    $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody tr:not(:first-child)').empty()
    var val = $.trim($('#productCode').val());
    var r = /^\d+$/;
    // if(val != ''){
    //   if(r.test(val) == true){  
    //       if(val.length < 6){
    //         showError('SKU至少输入6位');
    //         $('#productCode').focus();
    //         return false;
    //       }else{
    //         clearError();
    //       }
    //    }else{  
    //       if(val.length < 2){
    //         showError('名称至少2个字符');
    //         $('#productCode').focus();
    //         return false;
    //       }else{
    //         clearError();
    //       }
    //   }
    // }else{
    //   false;
    // }  
      tab2_click_callback();
    })
  $('.nx-btn-gift-search').click(function(){
    $('#tab3 .cx-gift .wrap.has tbody tr:not(:first-child)').empty();
    var val = $.trim($('#giftCode').val());
    var r = /^\d+$/;
    // if(val != ''){
    //   if(r.test(val) == true){  
    //       if(val.length < 6){
    //         showError('SKU至少输入6位');
    //         $('#productCode').focus();
    //         return false;
    //       }else{
    //         clearError();
    //       }
    //    }else{  
    //       if(val.length < 2){
    //         showError('名称至少2个字符');
    //         $('#productCode').focus();
    //         return false;
    //       }else{
    //         clearError();
    //       }
    //   }
    // }else{
    //   false;
    // }  
      tab3_click_callback();
  })
  var table_example;
  var render_table_example1 = function(data){
    if(typeof table_example !== 'undefined'){
        table_example.destroy();
    }  
    // showLoadingToast();
    table_example = $('#example').DataTable( {
      data: data.records,
      columns: data.headers,
      scrollX: '100%',
      scrollY: '535', 
      searching: false,
      sort:false,
      "fnCreatedRow": function( nRow, aData, iDataIndex ) {
          switch(aData[1]*1){
            case 1:
            break;
            case 2:
              $(nRow).addClass('soon');
            break;
            case 3:
              $(nRow).addClass('disabled');
            break;
          }

          var _img = '&nbsp;';
          // if(aData[7]){
          //   _img = '<img src="/nt_pos/web_mobile/static/lzsale/src/img/cuxiao/icon-check1.svg">';
          // }
          // if(aData[7] && (aData[1] == 2)){
          //   _img = '<img src="/nt_pos/web_mobile/static/lzsale/src/img/cuxiao/icon-check2.svg">';
          // }
          // $('.is_active',nRow).html(_img);


          $(nRow).click(function(){
            showDetail(aData[0],aData[1]);
          });

      },

      "initComplete": function(settings, json) {
          // showLoadingToast();
          $('#mainFooter').html('');
          $('#example_length').appendTo('#mainFooter');
          $('#example_info').appendTo('#mainFooter');
          $('#example_paginate').appendTo('#mainFooter');
          $('tr.odd').removeClass('odd');
          $('tr.even').removeClass('even');
          is_show_footer(records);
      },
      "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
      "language":   _LANG
    } );
    // hideLoadingToast();

  }
  //click search
  $('.nx-btn-display').click(function(){
      showLoadingToast();
      $('.data').removeClass('hidden');
      if($(this).hasClass('disabled')){
          return;
      }
      $(this).addClass('disabled');
      $(this).html('加载中');


      var promotion_type = [];
      var promotion_state = [];

      $('input[name=reason]:checked').each(function(){
          promotion_type.push($(this).val());
      })
      $('input[name=type]:checked').each(function(){
          promotion_state.push($(this).val());
      })

      var data = {
          limit:1000,
          offset:0,
          shop_id:shop_id,
          start_date:$('input[name=start_at]').val(),
          end_date:$('input[name=end_at]').val(),
          promotion_type:promotion_type,
          promotion_state:promotion_state,
          promotion_str:$('input[name=name_code]').val()
      };


      //促销列表查询
      if(xhr){
        xhr.abort();
      }  
      xhr = $.ajax({
        url: API_URL_PREFIX + API_URL['list'],
        data: JSON.stringify(data),
        type: 'POST',
          dataType : "json",
          contentType: "application/json",
        success:  function(data){
          records = [];
          var promotion_list = data.data.promotion_list;
          if(promotion_list){
            for(var i = 0 ; i < promotion_list.length ; i ++){
              records.push([
                promotion_list[i]['promotion_code'],
                promotion_list[i]['promotion_name'],
                promotion_list[i]['promotion_type'],
                promotion_list[i]['start_time'] + '<br />-<br />' + promotion_list[i]['end_time'], 
                promotion_list[i]['promotion_state']
              ])
            }
          }


              var _data = {
                  headers:[
                  {title : '促销代码'},
                  {title : '促销名称'},
                  {title : '销售类型'},
                  {title : '起始 - 结束',className: 'date'},
                  {title : '状态',className: 'is_active'}
                  ],
                  records:records
              };
              render_table_example1(_data);
        },
        error:    function(){
          console.log('error');
        },
        complete: function(){
          console.log('complete');
          hideLoadingToast();
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
        }
      })

      console.dir(data);

      $(this).removeClass('disabled');
      $(this).html('查询');
  })
  // $('.nx-btn-display').click();

  function showDetail(id,time_interval){
    $('body').addClass('show_detail');

    $(document).on("click", "#detailContent .back", function() {
        $('body').removeClass('show_detail');
    });

    $('#detailContent .condition input').val('');

    // $('.resultRecord').html('商品明细');
    clearError();
    //$('a[href="#tab1"]').click();
    $('.tab-link').removeClass('active');
    $('.tab-link[href="#tab1"]').addClass('active');
    $('.tabs .tab').removeClass('active');
    $('.tabs #tab1').addClass('active');
    
    var id = id;//getUrlParameter('id');
    _ID = id;
    _time_interval = time_interval;

    $('.tab-link[href="#tab1"]').click();
    tab1_click_callback();

    // get_num('product');
  }
  // function get_num(type){
  //       var _data = {
  //         promotion_code:_ID,
  //         type:type
  //       };

  //       $.ajax({
  //         url: API_URL_PREFIX + API_URL['info'],
  //           data: JSON.stringify(_data),
  //           type: 'POST',
  //           dataType : "json",
  //           contentType: "application/json",
  //         success:  function(data){
           
  //           _NUM[type] = data.total;

  //           $('.cx-product:not(.cx-gift) .resultRecord').html('其他单品');
  //           // $('.cx-product:not(.cx-gift) .resultRecord').html('总共 '+_NUM['product'] + ' 条');
  //           // $('.cx-gift .resultRecord').html('总共 '+_NUM['gift'] + ' 条');
  //         },
  //         error:    function(){
            
  //         },
  //         complete: function(){
  //         },
  //         beforeSend : function(request){
  //           request.setRequestHeader("token", token);
  //         }
  //       })
  // }

  // init detail 3page
  $('.hasext').click(function(){
    $(this).toggleClass('ext');
    if($(this).hasClass('ext')){
        $(this).next('.wrap').slideDown();
    }else{
        $(this).next('.wrap').slideUp();
    }
  })
  var tbl = {
      tblProduct:'',
      tblGift:'',
  };

  var render_table_example = function(id,data){
    if((typeof tbl !== 'undefined') && (typeof tbl[id] !== 'undefined') && (tbl[id] != '')){
        tbl[id].destroy();
    }

    tbl[id] = $('#'+id).DataTable( {
      data: data.records,
      columns: data.headers,
      scrollX: '100%',
      scrollY: '360',//768 - 70 - 50 - 50 - 50 - 66 
      sort:false,
      "fnCreatedRow": function( nRow, aData, iDataIndex ) {
          $('.loading-shop').addClass('hidden');
            switch(aData[1]*1){
              case 1:
              break;
              case 2:
                $(nRow).addClass('soon');
              break;
              case 3:
                $(nRow).addClass('disabled');
              break;
            }

            var _img = '&nbsp;';
            if(aData[5]){
              _img = '<img src="assets/img/icon-check1.svg">';
            }
            if(aData[5] || aData[6]){
              _img = '<img src="assets/img/icon-check1.svg">';
            }
            $('.is_active',nRow).html(_img);


            // $(nRow).click(function(){
            //   showDetail(aData[0],aData[1]);
            // });
        },
      "initComplete": function(settings, json) {
        if(id == 'tblProduct'){
          $('#detailContent #tab2 footer').html('');
          $('#detailContent #tab2 footer').removeClass('hidden');
          $('#'+id + '_length').appendTo('#detailContent #tab2 footer');
          $('#'+id + '_info').appendTo('#detailContent #tab2 footer');
          $('#'+id + '_paginate').appendTo('#detailContent #tab2 footer');
          $('tr.odd').removeClass('odd');
          $('tr.even').removeClass('even');
          $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
          is_show_footer(data.records,'#detailContent #tab2 footer');
        }
        if(id == 'tblGift'){
          $('#detailContent #tab3 footer').html('');
          $('#detailContent #tab3 footer').removeClass('hidden');
          $('#'+id + '_length').appendTo('#detailContent #tab3 footer');
          $('#'+id + '_info').appendTo('#detailContent #tab3 footer');
          $('#'+id + '_paginate').appendTo('#detailContent #tab3 footer');
          $('tr.odd').removeClass('odd');
          $('tr.even').removeClass('even');
          $('.cx-gift footer').removeClass('hidden');
          is_show_footer(data.records,'#detailContent #tab3 footer');
        }

          // if(id == 'tblProduct'){
          //   $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
          // }
          // if(id == 'tblGift'){
          //   $('.cx-gift footer').removeClass('hidden');
          // }

        },
      "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
          "language":   _LANG
    } )
    $('.button[data-table="#'+id+'"]').unbind('click').bind('click',function(){
        $('#'+id).DataTable()
        .search( $(this).parents('.condition').find('input').val() )
        //.search('ABC')
        .draw();
    })
  }
  $('a[href="#tab1"]').click(function(){
    if(!$(this).hasClass('active')){
      tab1_click_callback();
    } 
  })
  function render_detail(data){
    $('.label-box').html('');
    data = data.data;
    if(data.promotion_member_level_list.length != 0){
      //会员等级
      for(var i = 0 ; i < data.promotion_member_level_list.length ;i++){
          data.member_level_name = data.promotion_member_level_list[i]['member_level_name'];
          data.member_discount = data.promotion_member_level_list[i]['member_discount'];
      }
    }else{
      $('#tab1 table.cx').hide();
    }
    

    //活动券
    data.user_coupon_str = (data.user_coupon)?'必须使用':'不必须';

    //活动券
    // data.w_skus = data.w_skus.replace(',',' , ');
    // data.w_ex_skus = data.w_ex_skus.replace(',',' , ');
    // data.z_skus = data.z_skus.replace(',',' , ');
    // data.z_ex_skus = data.z_ex_skus.replace(',',' , ');
    //倒计时
    //1：时间范围内；2：待开始；3：已过期；4：未设置
    $('.timeline').removeClass('timeline1 timeline2 timeline3');
    data.time_interval = _time_interval;
    switch(data.promotion_state){
      case 'in_progress':
        $('.timeline').addClass('timeline1');
        // var d = Math.ceil((new Date(data.end_time.substring(0,10)).getTime() - new Date().getTime())/86400000);

        data.counter_str = '距离结束还有 '+data.distance_end_day +' 天';

        data.counter_str = '距离结束还有 '+ data.distance_end_day +' 天';
      break;
      case 'not_start':
        $('.timeline').addClass('timeline2');
        data.counter_str = '活动未开始';
      break;
      case 'ended':
        $('.timeline').addClass('timeline3');
        data.counter_str = '活动已过期';
      break;
      case '进行中':
        $('.timeline').addClass('timeline1');
        // var d = Math.ceil((new Date(data.end_time.substring(0,10)).getTime() - new Date().getTime())/86400000);

        data.counter_str = '距离结束还有 '+data.distance_end_day +' 天';

        data.counter_str = '距离结束还有 '+ data.distance_end_day +' 天';
      break;
      case '未开始':
        $('.timeline').addClass('timeline2');
        data.counter_str = '活动未开始';
      break;
      case '已结束':
        $('.timeline').addClass('timeline3');
        data.counter_str = '活动已过期';
      break;
      default:
        data.counter_str = '活动已开始';
      break;
    }
    for(var ss in data){
        $('*[data-rel="'+ss+'"]').html(data[ss]);
        $('*[data-rel="'+ss+'"]').val(data[ss]);
    }

    if(data.is_active){
        $('.label-box').append('<span>有效</span>');
    }else{
        $('.label-box').append('<span>无效</span>');
    }
    if(data.overlap_order_rule){
        $('.label-box').append('<span>整单活动</span>');
    }

    $('.label-box').append('<span>'+data.reason_name+'</span>');
    
    if(data.from_crm){
        $('.label-box').append('<span>CRM活动</span>');
    }
  }
  function tab1_click_callback(){
    var _data = {promotion_code:_ID,shop_id:shop_id};
    if(xhr){
      xhr.abort();
    }

    xhr = $.ajax({
      url: API_URL_PREFIX + API_URL['info'],
      data: JSON.stringify(_data),
      type: 'POST',
        dataType : "json",
        contentType: "application/json",
      success:  function(data){
        $('.loading-detail').remove();
        $('.cx-detail').removeClass('hidden');
        render_detail(data);
      },
      error:    function(){
        $('.loading-detail').html('没有信息');
        
      },
      complete: function(){
        // hideLoadingToast();
        $('.loading-detail').remove();
        $('.cx-detail').removeClass('hidden');
      },
      beforeSend : function(request){
        request.setRequestHeader("token", token);
        $('.loading-detail').html('加载中...');
      }
    })
  }
  $('a[href="#tab2"]').click(function(){
    if(!$(this).hasClass('active')){
      $('.loading-product').addClass('hidden');
      $('.cx-product:not(.cx-gift)').removeClass('hidden');
      $('#detailContent footer').addClass('hidden');
      $('#tab2 .cx-product .wrap.has.include_scope tbody tr:not(:first-child)').empty()
      $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody tr:not(:first-child)').empty()
      tab2_click_callback();
    }
  })
  function tab2_click_callback(){
    var is_include;
    if($('input[name=tab2_tab]:checked').attr('data-type') == 'include_scope'){
      is_include = true
    }else{
      is_include = false
    }
    var _data = {
        promotion_code:_ID,
        limit:999,
        offset:0,
        is_include:is_include
    };
    var xhr1;
    if(xhr1){
      xhr1.abort();
    }
    xhr1 = $.ajax({
        url: API_URL_PREFIX + API_URL['scope'],
        data: JSON.stringify(_data),
        type: 'POST',
        dataType : "json",
        contentType: "application/json",
        success:  function(data){
          $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody').empty();
          data = data.data.scope_list;
            for(var i = 0;i<data.length;i++){
              $('#tab2 .cx-product .wrap.has.include_scope tbody').append('<tr><td>'+data[i].include_scope+'</td><td>'+data[i].quantity+'</td><td>'+data[i].amount+'</td><td>'+data[i].discount+'</td><td>'+data[i].discount_amount+'</td><td>'+data[i].price+'</td></tr>');
            }
            
            for(var i = 0;i<data.length;i++){
              if(data[i].exclude_scope == ''){
                $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody').append('<td style="position: relative;left: 45%;padding: 10px">暂无数据</td>');
              }else{
                $('#tab2 .cx-product .wrap.nohas.exclude_scope tbody').append('<tr><td>'+data[i].exclude_scope+'</td><td>'+data[i].quantity+'</td><td>'+data[i].amount+'</td><td>'+data[i].discount+'</td><td>'+data[i].discount_amount+'</td><td>'+data[i].price+'</td></tr>');
              }
              
            }
          // else{
          // //   $('#tab2 .wrap.nohas table').html('暂无数据');
          // // } 
        },
        error:    function(){
          $('.loading-product').html('没有信息');
        },
        complete: function(){
          $('.loading-product').addClass('hidden');
          $('.cx-product:not(.cx-gift)').removeClass('hidden');
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
          $('.loading-product').removeClass('hidden');
          $('.cx-product:not(.cx-gift)').addClass('hidden');
          $('.loading-product').html('加载中...');
        }
    })
    var is_includes;
    if($('input[name=tab2]:checked').attr('data-type') == 'true'){
      is_includes = true
    }else{
      is_includes = false
    }
    var _datas = {
        promotion_code:_ID,
        limit:999,
        offset:0,
        product_str:$('#productCode').val(),
        is_include:is_includes
    };
    if(xhr){
      xhr.abort();
    }
    xhr = $.ajax({
        url: API_URL_PREFIX + API_URL['productList'],
        data: JSON.stringify(_datas),
        type: 'POST',
          dataType : "json",
          contentType: "application/json",
        success:  function(data){
            var records = [];
            if(!!!data.data.products){return};
            for(var i =0;i<data.data.products.length;i++){
                records.push(
                    [
                    data.data.products[i]['product_code'],
                    data.data.products[i]['product_name'],
                    data.data.products[i]['sale_price'],
                    data.data.products[i]['discount'],
                    data.data.products[i]['price'],
                    data.data.products[i]['is_active']
                    ]
                    );
            }
            var _data = {
                headers:[{title : '物品编码'},
                {title : '物品名称'},
                {title : '正价'},
                {title : '折扣'},
                {title : '促销价'},
                {title : '生效',className: 'is_active'}],
                records:records
            };
            setTimeout(function(){
                render_table_example('tblProduct',_data);
            },100);
        },
        error:    function(){
          $('.loading-product').html('没有信息');
        },
        complete: function(){
          $('.loading-product').addClass('hidden');
          $('.cx-product:not(.cx-gift)').removeClass('hidden');
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
          
          $('.loading-product').html('加载中...');
        }
    })

  }
  $('a[href="#tab3"]').click(function(){
    if(!$(this).hasClass('active')){
        tab3_click_callback();
    }
  })
  function tab3_click_callback(){
    var is_include;
    if($('input[name=tab3]:checked').attr('data-type') == 'true'){
      is_include = true
    }else{
      is_include = false
    }
    var _data = {
          promotion_code:_ID,
          limit:999,
          offset:0,
          product_str:$('#giftCode').val(),
          is_include:is_include
      };
    var _datas = {
      promotion_code:_ID,
      limit:999,
      offset:0,
      product_str:$('#giftCode').val(),
      is_include:true
    };
    
    if(xhr){
      xhr.abort();
    }
    xhr = $.ajax({
        url: API_URL_PREFIX + API_URL['productScope'],
        data: JSON.stringify(_datas),
        type: 'POST',
          dataType : "json",
          contentType: "application/json",
        success:  function(data){
          $('.loading-gift').addClass('hidden');
          $('.cx-gift').removeClass('hidden');
          if(!!data.scope_list){
            for(var i = 0;i<data.scope_list.length;i++){
              $('#tab3 .cx-product .wrap.has tbody').append('<tr><td>'+data.scope_list[i].include_scope+'</td><td>'+data.scope_list[i].price+'</td><td>'+data.scope_list[i].point+'</td><td>'+data.scope_list[i].quantity+'</td></tr>');
            }
          }else{
            return;
          }
        },
        error:    function(){
          $('.loading-gift').html('没有信息');
          
        },
        complete: function(){
          $('.cx-gift').removeClass('hidden');
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
          $('.loading-gift').html('加载中...');
          $('.loading-gift').removeClass('hidden');
          $('.cx-gift').addClass('hidden');
        }
    }) 
    var xhr2;
    if(xhr2){
      xhr2.abort();
    }
    xhr2 = $.ajax({
        url: API_URL_PREFIX + API_URL['productLists'],
        data: JSON.stringify(_data),
        type: 'POST',
          dataType : "json",
          contentType: "application/json",
        success:  function(data){
          // var data = {
          //     "promotion_gift_products": [
          //             {
          //                 "product_code": "34984599",
          //                 "product_name": "针织衫",
          //                 "sale_price": 200,
          //                 "quantity": 2,
          //                 "price": 160,
          //                 "point":320,
          //                 "is_active": true
          //             }
          //         ]
          // }
          if(!!!data.data.products){return};
          $('.loading-gift').addClass('hidden');
          $('.cx-gift').removeClass('hidden');
          var records = [];
          for(var i =0;i<data.data.products.length;i++){
              records.push(
                  [
                  data.data.products[i]['product_code'],
                  data.data.products[i]['product_name'],
                  data.data.products[i]['sale_price'],
                  data.data.products[i]['quantity'],
                  data.data.products[i]['point'],
                  data.data.products[i]['price'],
                  data.data.products[i]['is_active'],
                  ]
                  );
          }
          var _data = {
              headers:[{title : '物品编码'},
              {title : '物品名称'},
              {title : '正价'},
              {title : '换购积分'},
              {title : '换购价'},
              {title : '数量'},
              {title : '生效',className: 'is_active'}],
              records:records
          };
          setTimeout(function(){
              render_table_example('tblGift',_data);
          },100);
        },
        error:    function(){
          $('.loading-gift').html('没有信息');
          
        },
        complete: function(){
          $('.cx-gift').removeClass('hidden');
        },
        beforeSend : function(request){
          request.setRequestHeader("token", token);
          $('.loading-gift').html('加载中...');
          $('.loading-gift').removeClass('hidden');
          $('.cx-gift').addClass('hidden');
        }
    })
  }



})

function translate1(){
  //判断 localStorage 缓存
  $('#panel-reason .close-panel.confirm').click();
  $('#panel-type .close-panel.confirm').click();
}

if (langs.indexOf(langCode) != -1){
  $.getJSON('assets/lang/'+langCode+'.json', {},translate1);
}else{
  $.getJSON('assets/lang/cn.json', translate1);
}

</script>
<script type="text/javascript">
  document.title = '促销查询';
</script>
<#include 'inc.bottom.html'>