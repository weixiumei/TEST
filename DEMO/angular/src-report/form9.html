<#include 'inc.head.html'>

<body class="debugx">
<div id="bg"></div>
  <div id="container">
    <header>
        <span class="menu"></span>
        <a class="back_a" href=""><span class="menuBack"></span></a>
        <span tkey="form8_danju"></span><span class="blue" tkey="form9_tittle"></span>
        <span class="menuRight" tkey="filter"></span>
    </header>

    <section class="filter hidden">
      <span tkey="sum"></span>： <span class="filter_reason"></span> ；
      <span tkey="category"></span>： <span class="filter_category"></span> ；
      <span tkey="date"></span>： <span class="startDate"></span>/<span class="endDate"></span>
    </section>


<div class="condition">

    <div class="row" >
    <ul class="col-50">
      <li>
        <div class="item-content item-search">
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请输入商品编码" placeholder-key="code_desc" name="name_code" class="">
            </div>
          </div>
      </li>
      <li>
        <div class="item-content item-relative">
            <label><span tkey="sum"></span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请选择需统计项目" class="btn-panel relative-value" data-rel="panel-reason" readonly="" data-value="storage1" value="">
            </div>
          </div>
      </li>
      <li>
        <div class="item-content item-relative">
            <label><span tkey="category"></span>:</label>
            <div class="item-input">
              <!--relative-value 表示 一个输入框 对应 一个 右侧划入的列表-->
              <input type="text" placeholder="请选择需统计项目" class="btn-panel relative-value" data-rel="panel-category" readonly="" data-value="storage2" value="">
            </div>
          </div>
      </li>
      
      <li>
        <div>
          <input type="date" data-toggle="date" class="datepicker" value="" name="start_at">
          <span class="datepicker-split">-</span>
          <input type="date" data-toggle="date" class="datepicker" value="" name="end_at">
        </div>
      </li>
      <li>
        <span class="checkbox">
          <span class="input-checkbox checked">
            <input type="checkbox" name="checkBox" value="combined" checked="" data-label="" checked />
            <span class="inner"></span>
          </span>
        </span>
        <span class="style_top" tkey="has_money" style="top:0"></span>
      </li>



      <!-- <li class="col-100">
        <div class="item-content no-border item-button" style="margin-top: 40px">
          <button class="button button-fill button-primary" id="clear" tkey="clear">重置</button>
          <button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
        </div>
      </li> -->
      </ul>
      <ul class="col-50" style="width:40%!important">
        <li class="col-100">
          <div class="item-content no-border item-button" style="margin-left: 100px">
            <!-- <button class="button button-fill button-primary" id="clear" tkey="clear">重置</button> -->
            <button class="button button-fill button-primary nx-btn-display" id="getList" data-table="#example" style="margin-left: 0px;" tkey="search"></button>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <div class="data hidden">
      <table class="display nx-datatables" id="example" width="100%">
        <thead>
          <tr></tr>
        </thead>
      </table>

      <section class="count">
        <p class="blue label"><span tkey="heji"></span>|</p>
        <p class="footer"></p>
      </section>
       <!-- loading -->
      <div class="data_content">
        <div>
          <img src="assets/img/loading_b.gif" alt="">
        </div>
      </div>
      <footer id="mainFooter">
        
      </footer>
    </div>
</div>


<!-- * 业务单据 -->
<!-- * 业务单据 --><!-- * 店面进销存 -->
<div class="panel panel-right panel-cover" id='panel-reason'>
    <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="sum"></span>
    <a href="#" class="close-panel confirm confirm_1" tkey="sure"></a>
    </header>

    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" tkey="total_desc"></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
      </div>
</div>
<!-- 分类 -->
<div class="panel panel-right panel-cover" id='panel-category'>
    <header>
    <a href="#" class="close-panel back"></a>  
    <span tkey="category"></span>
    <a href="#" class="close-panel confirm confirm_2" tkey="sure"></a>
    </header>

    <!-- Click on link with "close-panel" class will close panel -->
    <div class="list-block">
      <p class="small" tkey="total_desc"></p>
      <ul>
        <!-- Single chekbox item -->
        <li tkey="loading"></li>
      </ul>
      </div>
</div>


    <#include 'inc.script.html'>

<!-- 
<script src="assets/api/api.config.js"></script>
<script src="assets/api/api.js"></script> -->



<script>
var xhr,xhr1;
var _ID = 0;
var _count ;//获取侧滑id
var _NUM = {'product':0,'gift':0};
var _time_interval = false;
var shop_id = getUrlParameter('shop_id') * 1;
var lang = getUrlParameter('lang');
var back_url='index.html'+ '?shop_id=' + shop_id + '&lang=' + lang; 
$('.back_a').attr('href',back_url);

// 判断缓存
if(sessionStorage.getItem('reason9')){
  $('.filter_reason').html(sessionStorage.getItem('reason9'));
}
if(sessionStorage.getItem('category9')){
  $('.filter_category').html(sessionStorage.getItem('category9'));
}


//点击弹出右侧的panel    
$(document).on("click", ".btn-panel", function() {
    var id = $(this).attr('data-rel');
    $.openPanel("#"+id);
    $('#bg').show();
    _count = "#"+id;
    $('.panel.panel-right.panel-cover'+_count+' ').show();
});
$('.panel header .back').on("click",function(){
  $('#bg').hide();
})
$('#bg').on("click",function(){
   $.closePanel(_count);
  // $('.panel.panel-right.panel-cover'+_count+' ').hide();
  $(this).hide();
})
$('.panel header .confirm').on("click",function(){
  $('#bg').hide();
})
// 点击背景可以直接回填值
$(document).on("close", ".panel", function(e, pageId, $page) {
  $(this).find('.close-panel').click();
});
// $(".datepicker").calendar({
//     value: ['2015-12-05']
// });


// $('.relative-value').each(function(){
//     var s = $(this).attr('data-value');
//     var that = $(this);
//     $('input[name="'+s+'"]').change(function(){
//         var str = '';
//         $('input[name="'+s+'"]').each(function(){
//             if(!$(this).prop('checked')){
//                 return;
//             }
//             str += (str != '')? ',' + $(this).val() : $(this).val();
//         })
//         that.val(str);
//     })
// })



jQuery(document).ready(function($){

  //商品编码
  $('input[name=name_code]').val(localStorage.form9_product_code);
  //with_the_mount
  if(localStorage.form9_with_the_mount == '0'){
    $('li .checkbox .input-checkbox input[value="combined"]').removeAttr("checked");
    $('li .checkbox .input-checkbox input[value="combined"]').parent().removeClass("checked");
  }else{
    $('li .checkbox .input-checkbox input[value="combined"]').attr("checked","checked");
    $('li .checkbox .input-checkbox input[value="combined"]').parent().addClass("checked");
  }

  $('.filterButton').click(function(){
    $('.filter').addClass('hidden');
    $('#container > .condition').removeClass('hidden');
  })

  $('#getList').click(function(){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
  })
  
  // 筛选
  var flag = true; 
  $('.menuRight').click(function(){
    if(flag){
      $('.filter').removeClass('hidden');
      $('#container > .condition').addClass('hidden');
      $('.data').removeClass('hidden');
      flag = false;
    }else{
      $('.filter').addClass('hidden');
      $('#container > .condition').removeClass('hidden');
      $('.data').addClass('hidden');
      flag = true;
    }
  })


  var date = new Date();
  var didDate = date.setDate(date.getDate()-6);
  var year = date.getFullYear();
  var month = date.getMonth()+1;
  var day = date.getDate();
  if(String(month).length == 1){
    month = '0' + month;
  }
  if(String(day).length == 1){
    day = '0' + day;
  }
  var year_month_day = year + '-' + month + '-' + day +'';
  if(sessionStorage.getItem('start9')){
    $('.startDate').text(sessionStorage.getItem('start9'));
    $('input[name=start_at]').val(sessionStorage.getItem('start9'))
  }else{
    $('input[name=start_at]').val(year_month_day);
    $('.startDate').text($('input[name=start_at]').val());
  }
  if(sessionStorage.getItem('end9')){
    $('.endDate').text(sessionStorage.getItem('end9'));
    $('input[name=end_at]').val(sessionStorage.getItem('end9'))
  }else{
    $('input[name=end_at]').val(new Date().Format("yyyy-MM-dd"));
    $('.endDate').text($('input[name=end_at]').val());
  }

  $('input[name=start_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=start_at]').val($('input[name=end_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('start9',$('input[name=start_at]').val());
  })
  $('input[name=end_at]').change(function(){
    var start_at = $('input[name=start_at]').val();
    var end_at = $('input[name=end_at]').val();
    if(start_at > end_at ){
      $('input[name=end_at]').val($('input[name=start_at]').val())
    }
    $('.startDate').text($('input[name=start_at]').val()); 
    $('.endDate').text($('input[name=end_at]').val());
    sessionStorage.setItem('end9',$('input[name=end_at]').val());
  })

  if(localStorage.form9_start_date != undefined){
      //startdate,enddate
      $('input[name=start_at]').val(localStorage.form9_start_date);
      $('input[name=end_at]').val(localStorage.form9_end_date);
  }

  $('.nx-btn-product-search').click(function(){
    var val = $.trim($('#productCode').val());
    var r = /^\d+$/;

    if(r.test(val) == true)  
     {  
        if(val.length < 6){
          showError('SKU至少输入6位');
          $('#productCode').focus();
          return false;
        }else{
          clearError();
        }
     }  
    else  
    {  
      if(val.length < 2){
        showError('商品名称至少输入2个字符');
        $('#productCode').focus();
        return false;
      }else{
        clearError();
      }
    }  
      tab2_click_callback();
    })
    

      var table_example;
      var TABLE = '';
      function reset(){
        if(!!table_example){
            table_example.destroy();
        }
        table_example='';
        $('.data table').remove();
        var t = TABLE.clone();
        $('.data').append(t);
      }
      TABLE = $('.data table').clone();

        var render_table_example1 = function(cols){
          // if(!!table_example){
          //   table_example.ajax.reload();
          //   return;
          // }
          var _columns = [];
          var _columns_sort = ['style'];
          for(var i = 0; i < cols.length; i++){
            if($.inArray(cols[i], _columns_sort) >= 0){
              _columns.push({orderable:false});
            }else{
              _columns.push(null);
            }
          }

          var tbody_height = $(window).height() - $('header')[0].clientHeight - $('section.filter')[0].clientHeight - $('table thead')[0].clientHeight - $('section.count')[0].clientHeight - $('footer#mainFooter')[0].clientHeight;
          
          table_example = $('#example').DataTable( {
            scrollX: '100%',
            scrollY: tbody_height,
            searching: false,
            sort:true,
            columns:_columns,
            order:[],

            "bProcessing" : true,  
            "bServerSide" : true,
             
             ajax:{
                url: API_URL_PREFIX+API_URL['delivery_inventory'],
                type: 'POST',
                headers:{token:token},
                dataType : "json",
                contentType: "application/json",
                data: function(d){
                  // showLoadingToast();
                  var product_type = [];
                  $('input[name=category]:checked').each(function(){
                      product_type.push($(this).val());
                  })
                  d.limit = d.length;
                  d.offset = d.start;
                  d.current_page = 1 + d.start / d.limit;
                  d.shop_id = shop_id;
                  d.start_date = $('input[name=start_at]').val();
                  d.end_date = $('input[name=end_at]').val();
                  // d.group_level = $('input[name=reason]:checked').val();
                  d.group_by = $('input[name=reason]:checked').val();
                  d.product_type = product_type;
                  d.product_code = $('input[name=name_code]').val();
                  d.with_the_mount = Number($('input[name=checkBox]')[0].checked);
                  
                  if(d.order.length > 0){
                    var _order_by = $('.dataTables_scrollHead th:eq('+d.order[0].column+')').attr('data-code');
                    var _is_desc = (d.order[0].dir == 'asc')?0:1;

                    d.order_by= _order_by;
                    d.is_desc= _is_desc;
                  }


                  return (JSON.stringify(d));
                },
                dataSrc:  function(data){
                  // data = data.data;
                  // $('.data_content').hide();
                  // hideLoadingToast();
                  records = [];
                  if(data['records']){
                    for(var i = 0 ; i < data['records'].length ; i ++){
                      var _data = [];
                        for(var j=0; j < cols.length; j++){
                          _data.push(data['records'][i][cols[j]]);
                        }
                        records.push(_data);
                    }
                  }
                  window.scrollTo(0,0);
                  return records
                },
              },
            "initComplete": function(settings, json) {
              $('#mainFooter').html('');
              $('#example_length').appendTo('#mainFooter');
              $('#example_info').appendTo('#mainFooter');
              $('#example_paginate').appendTo('#mainFooter');
              is_show_footer(records);
            },
          "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
          "language":   _LANG
        } );

          new $.fn.dataTable.FixedColumns( table_example, {
              leftColumns: 1
          } );

        }

        //init 汇总
        if(xhr){
          xhr.abort();
        }
        // var shop_id = getShopId('shop_id=');
        xhr = $.ajax({
          url: API_URL_PREFIX+API_URL['shop_inventory_view_list'],
          data: JSON.stringify({}),
          type: 'POST',
          dataType : "json",
          contentType: "application/json",
          success:  function(data){
            if(data.code != 0){
              _error_handle(data);
              return;
            }
            data = data.data;
                    var str = '';
                    var checked_reason = '';
                    for(i=0;i<data.data.length;i++){
                        var name = data.data[i]['type_name'];
                        var code = data.data[i]['type_code'];
                        if(localStorage.form9_group_by!=undefined && localStorage.form9_group_by!='' && localStorage.form9_group_by!=null){
                              checked_reason = (localStorage.form9_group_by.split(',').indexOf(code+'') != -1)?'checked':'';
                            }
                        str += '<li><label class="lb" for="reason'+i+'">\
                                '+ name +'\
                                <span class="checkbox">\
                                  <span class="input-radio '+ checked_reason +'">\
                                    <input type="radio" name="reason" id="reason'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                                    <span class="inner"></span>\
                                  </span>\
                                </span></label>\
                              </li>';
                    }
                $('#panel-reason ul').html(str);
                $(document).on("click", "#panel-reason .close-panel.confirm_1", function() {
                  var s = '';
                  if($(this).parents('.panel').find('input[type=radio]').size() == $(this).parents('.panel').find('input[type=radio]:checked').size()){
                    s = '全部汇总';
                  }else{

                    $(this).parents('.panel').find('input[type=radio]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                  }
                  $('input[data-value="storage1"]').val(s);
                  sessionStorage.setItem('reason9',s);
                  $('.filter_reason').html(s);

              });
              //判断 localStorage 缓存
              if(localStorage.form9_filter_reason!='' && localStorage.form9_filter_reason!=undefined){
                $('.filter_reason').html(localStorage.form9_filter_reason);
                $('input[data-value="storage1"]').val(localStorage.form9_filter_reason);
                $("#panel-reason input[value='"+localStorage.form9_group_by+"']").click();
              }else{
                // 默认选中
                $('#panel-reason input[value="code"]').click();
                // $('#panel-reason input[value="code"]').click();
              }
              $('#panel-reason .close-panel.confirm_1').click();

        //初始点击
        // $('#getList').click();
          },
          error:    function(data){
            console.log('error');
            _error_handle(data);
          },
          complete: function(){
            console.log('complete');
          },
          beforeSend : function(request){
            request.setRequestHeader("token", token);
          }
        })

        //init 分类
        if(xhr1){
          xhr1.abort();
        }
        // var shop_id = getShopId('shop_id=');
        xhr1 = $.ajax({
          url: API_URL_PREFIX+API_URL['product_types'],
          data: JSON.stringify({}),
          type: 'POST',
          dataType : "json",
          contentType: "application/json",
          success:  function(data){
            if(data.code != 0){
              _error_handle(data);
              return;
            }
            data = data.data;
                    var str = '';
                    var checked_category = '';
                    for(i=0;i<data.data.length;i++){
                        var name = data.data[i]['type_name'];
                        var code = data.data[i]['type_code'];
                        if(localStorage.form9_product_type!=undefined && localStorage.form9_product_type!='' && localStorage.form9_product_type!=null){
                              checked_category = (localStorage.form9_product_type.split(',').indexOf(code+'') != -1)?'checked':'';
                            }
                        str += '<li><label class="lb" for="category'+i+'">\
                                '+ name +'\
                                <span class="checkbox">\
                                  <span class="input-checkbox '+ checked_category +'">\
                                    <input type="checkbox" name="category" id="category'+i+'" value="'+ code +'" data-label="'+ name +'" />\
                                    <span class="inner"></span>\
                                  </span>\
                                </span></label>\
                              </li>';
                    }
                $('#panel-category ul').html(str);
                $(document).on("click", "#panel-category .close-panel.confirm_2", function() {
                  var s = '';
                  if($(this).parents('.panel').find('input[type=checkbox]').size() == $(this).parents('.panel').find('input[type=checkbox]:checked').size()){
                    
                    if(langCode == 'en'){
                        s = 'All';
                      }else{
                        s = '全部分类类型';
                      }
                  }else{

                    $(this).parents('.panel').find('input[type=checkbox]:checked').each(function(){
                        if(s != ''){
                            s += ',';
                        }
                        s +=  $(this).attr('data-label');
                    });
                  }
                  $('input[data-value="storage2"]').val(s);
                  sessionStorage.setItem('category9',s);
                  $('.filter_category').html(s);

              });
              //判断 localStorage 缓存
              if(localStorage.form9_filter_category!='' && localStorage.form9_filter_category!=undefined){
                $('.filter_category').html(localStorage.form9_filter_category);
                $('input[data-value="storage2"]').val(localStorage.form9_filter_category);
                var form9_product_type = localStorage.form9_product_type.split(',');
                for(var i=0;i<form9_product_type.length;i++){
                  $("#panel-category ul li .input-checkbox input[value='"+form9_product_type[i]+"']").click();
                }
              }else{
                // 默认选中
                $('#panel-category ul li:first-child .input-checkbox input').click();
              }
              $('#panel-category .close-panel.confirm_2').click();

        //初始点击
        // $('#getList').click();
          },
          error:    function(data){
            console.log('error');
            _error_handle(data);
          },
          complete: function(){
            console.log('complete');
          },
          beforeSend : function(request){
            request.setRequestHeader("token", token);
          }
        })

            
        //click search
        $('.nx-btn-display').click(function(){
          $('.data_content').show();
          // showLoadingToast();
          flag = false;
          $('.data').removeClass('hidden');
          $('.allDate').html($('input[name=start_at]').val() +'至'+ $('input[name=end_at]').val() );
            if($(this).hasClass('disabled')){
                return;
            }
            $(this).addClass('disabled');
            $(this).html('加载中');
            reset();
            var product_type = [];
            $('input[name=category]:checked').each(function(){
                product_type.push($(this).val());
            })

            var data = {
              current_page:1,
              limit:10,
              product_code:$('input[name=name_code]').val(),
              start_date:$('input[name=start_at]').val(),
              end_date:$('input[name=end_at]').val(),
              shop_id:shop_id,
              // group_level:$('input[name=reason]:checked').val(),
              group_by:$('input[name=reason]:checked').val(),
              product_type:product_type,
              with_the_mount:Number($('input[name=checkBox]')[0].checked),
            };

            //条件放人缓存
            setConditionlocalstorage('form9',data);

            //店面进销存查询
            if(xhr){
              xhr.abort();
            }  
            xhr = $.ajax({
              url: API_URL_PREFIX+API_URL['delivery_inventory'],
              data: JSON.stringify(data),
              type: 'POST',
              dataType : "json",
              contentType: "application/json",
              success:  function(data){
                $('.data_content').hide();
                if(data.code != 0){
                  _error_handle(data);
                  return;
                }
                data = data.data;
                var data_data = {
                    'record_count':'record_qty',
                    'page_count':'page_qty',
                    'begin_amount_sum':'begin_total_amount',
                    'deliver_out_amount_sum':'deliver_out_total_amount',
                    'retreat_count_sum':'retreat_total_qty',
                    'receive_amount_sum':'receive_total_amount',
                    'retreat_amount_sum':'retreat_total_amount',
                    'sale_count_sum':'sale_total_qty',
                    'deliver_in_count_sum':'deliver_in_total_qty',
                    'deliver_in_amount_sum':'deliver_in_total_amount',
                    'scrap_amount_sum':'scrap_total_amount',
                    'inventory_amount_sum':'inventory_total_amount',
                    'inventory_count_sum':'inventory_total_qty',
                    'sale_amount_sum':'sale_total_amount',
                    'scrap_count_sum':'scrap_total_qty',
                    'receive_count_sum':'receive_total_qty',
                    'begin_count_sum':'begin_total_qty',
                    'deliver_out_count_sum':'deliver_out_total_qty',
                    'end_count_sum':'end_total_qty',
                    'end_amount_sum':'end_total_amount'
                }
                for(var ss in data_data){
                    data[ss] = data[data_data[ss]];
                }

                records = [];
                if(data['records']){
                  for(var i = 0 ; i < data['records'].length ; i ++){
                    records.push([
                      data['records'][i]['sale_code'],
                      data['records'][i]['brand'],
                      data['records'][i]['sale_count'],
                      data['records'][i]['sale_amount'],
                      data['records'][i]['stock_count'], 
                      data['records'][i]['stock_amount']
                    ])
                  }
                }
                // var _data = {
                //     headers:[
                //     {title : data.table_headers.sale_code},
                //     {title : data.table_headers.brand},
                //     {title : data.table_headers.sale_count},
                //     {title : data.table_headers.sale_amount},
                //     {title : data.table_headers.stock_count},
                //     {title : data.table_headers.stock_amount}
                //     ],
                //     records:records
                // };

                var _data = {};
                var cols = [];
                var headers = [];
                var records = [];
                for(var i = 0 ; i < data.table_headers.length ;i++){

                    for(var ss in data.table_headers[i]){
                        headers.push({title : data.table_headers[i][ss]});
                        cols.push(ss);
                        if($('table thead tr').length == 1){
                          $('table thead tr').append('<th data-code="'+ss+'">'+data.table_headers[i][ss]+'</th>');
                        }

                    }
                }
                for(var i = 0 ; i < data.records.length; i++){
                    var tmp = [];
                    for(var j=0;j<cols.length;j++){
                        tmp[j] = data.records[i][cols[j]];
                    }
                    records.push(tmp);
                }
                // _data.records = records;
                // _data.headers = headers;
                render_table_example1(cols);

                // footer
                var footer = '';
                if(Number($('input[name=checkBox]')[0].checked) == 0){
                  footer += '<span tkey="footer9_1"></span>:<span class="footerStyle">'+data.begin_count_sum+'</span>\
                      <span tkey="footer9_2"></span>:<span class="footerStyle">'+data.end_count_sum+'</span>' 
                }else if(Number($('input[name=checkBox]')[0].checked) == 1){
                  footer += '<span tkey="footer9_1"></span>:<span class="footerStyle">'+data.begin_count_sum+'</span>\
                    <span tkey="footer9_3"></span>:<span class="footerStyle">'+data.begin_amount_sum+'</span>\
                    <span tkey="footer9_2"></span>:<span class="footerStyle">'+data.end_count_sum+'</span>\
                    <span tkey="footer9_4"></span>:<span class="footerStyle">'+data.end_amount_sum+'</span>\
                    ' 
                }
                // footer += '期初数量:<span class="footerStyle">'+data.begin_count_sum+'</span>\
                // 期初金额:<span class="footerStyle">'+data.begin_amount_sum+'</span>\
                // 期末数量:<span class="footerStyle">'+data.end_count_sum+'</span>\
                // 期末金额:<span class="footerStyle">'+data.end_amount_sum+'</span>\
                // ' 
                $('.footer').html(footer);
                if (langs.indexOf(langCode) != -1){
                  $.getJSON('assets/lang/'+langCode+'.json', {},translate);
                }else{
                  $.getJSON('assets/lang/cn.json', translate);
                }

                },
                error:    function(data){
                  console.log('error');
                  _error_handle(data);
                },
                complete: function(){
                  console.log('complete');
                },
                beforeSend : function(request){
                  request.setRequestHeader("token", token);
                }
            })

            console.dir(data);

            $(this).removeClass('disabled');
            $(this).html('查询');
        })







  // function showDetail(id,time_interval){
  //   $('body').addClass('show_detail');

  //   $(document).on("click", "#detailContent .back", function() {
  //       $('body').removeClass('show_detail');
  //   });

  //   $('#detailContent .condition input').val('');

  //   $('.resultRecord').html('统计中...');
  //   clearError();
  //   //$('a[href="#tab1"]').click();
  //   $('.tab-link').removeClass('active');
  //   $('.tab-link[href="#tab1"]').addClass('active');
  //   $('.tabs .tab').removeClass('active');
  //   $('.tabs #tab1').addClass('active');
    

  //   // if((typeof tbl['tblProduct'] !== 'undefined') && (tbl['tblProduct'] != '')){
  //   //                     tbl['tblProduct'].destroy();
  //   //                 }
  //   // if((typeof tbl['tblGift'] !== 'undefined') && (tbl['tblGift'] != '')){
  //   //                     tbl['tblGift'].destroy();
  //   //                 }



  //   var id = id;//getUrlParameter('id');
  //   _ID = id;
  //   _time_interval = time_interval;

  //   $('.tab-link[href="#tab1"]').click();
  //   tab1_click_callback();


  //   get_num('product');
  //   //get_num('gift');


    
  // }

  // //get number
  // function get_num(type){
  //       var _data = {
  //         rule_id:_ID,
  //         type:type
  //       };

  //       $.ajax({
  //         url: '/nt_project_lingzhi/web_mobile/api?object=nt.pos.html&method=lingzhi_promotion_rule_product_count',
  //           data: JSON.stringify(_data),
  //           type: 'POST',
  //           dataType : "json",
  //           contentType: "application/json",
  //         success:  function(data){
  //           _NUM[type] = data.total;

  //           $('.cx-product:not(.cx-gift) .resultRecord').html('总共 '+_NUM['product'] + ' 条');
  //           $('.cx-gift .resultRecord').html('总共 '+_NUM['gift'] + ' 条');
  //         },
  //         error:    function(){
            
  //         },
  //         complete: function(){
  //         },
  //         beforeSend : function(){
  //         }
  //       })
  // }



  //init detail 3page


    $('.hasext').click(function(){
        $(this).toggleClass('ext');
        if($(this).hasClass('ext')){
            $(this).next('.wrap').slideDown();
        }else{
            $(this).next('.wrap').slideUp();
        }
    })

    var tbl = {
        tblProduct:'',
        tblGift:'',
    };

            var render_table_example = function(id,data){

                    if((typeof tbl !== 'undefined') && (typeof tbl[id] !== 'undefined') && (tbl[id] != '')){
                        tbl[id].destroy();
                    }

                    tbl[id] = $('#'+id).DataTable( {
                        data: data.records,
                        columns: data.headers,
                        scrollX: '100%',
                        scrollY: '360',//768 - 70 - 50 - 50 - 50 - 66 
                        //searching: false,
                        sort:false,
                        // fixedHeader: {
                        //     header: true,
                        //     footer: true
                        // },
                        "initComplete": function(settings, json) {
                            $('#detailContent footer').html('');
                            $('#detailContent footer').removeClass('hidden');
                            $('#'+id + '_length').appendTo('#detailContent footer');
                            $('#'+id + '_info').appendTo('#detailContent footer');
                            $('#'+id + '_paginate').appendTo('#detailContent footer');
                            $('tr.odd').removeClass('odd');
                            $('tr.even').removeClass('even');

                            if(id == 'tblProduct'){
                              $('.cx-product:not(.cx-gift) footer').removeClass('hidden');
                            }
                            if(id == 'tblGift'){
                              $('.cx-gift footer').removeClass('hidden');
                            }

                          },
                        "lengthMenu": [ [10 , 20, 50, 80], ["10 / 页","20 / 页","50 / 页","80 / 页"] ],
                            "language":   _LANG



                    } )


                    $('.button[data-table="#'+id+'"]').unbind('click').bind('click',function(){
                        $('#'+id).DataTable()
                        .search( $(this).parents('.condition').find('input').val() )
                        //.search('ABC')
                        .draw();

                    })


                    // new $.fn.dataTable.FixedColumns( table_example, {
                    //         leftColumns: 1
                    //     } );

            }



})



</script>
<script type="text/javascript">
  document.title = '店面进销存';
</script>
<#include 'inc.bottom.html'>